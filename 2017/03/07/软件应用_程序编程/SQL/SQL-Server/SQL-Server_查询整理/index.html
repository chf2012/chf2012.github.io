<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="软件应用,程序编程,SQL," />





  <link rel="alternate" href="/atom.xml" title="Jimmy那些事儿" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="SQL 逻辑流Select 语法
Select语句的From部分将所有数据源组装进一个结果集，然后由Select语句的剩余部分对结果集执行操作。
Where子句作用于From组装的记录集，根据条件筛选某些行。
聚合函数对数据集执行求和操作。
Group by 子句根据在该子句中指定的列将大量数据集分组成较小的数据集。
Having 对较小的数据组执行聚合函数。
Order by 子句确定结果子的排">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server_常用查询">
<meta property="og:url" content="http://yoursite.com/2017/03/07/软件应用_程序编程/SQL/SQL-Server/SQL-Server_查询整理/index.html">
<meta property="og:site_name" content="Jimmy那些事儿">
<meta property="og:description" content="SQL 逻辑流Select 语法
Select语句的From部分将所有数据源组装进一个结果集，然后由Select语句的剩余部分对结果集执行操作。
Where子句作用于From组装的记录集，根据条件筛选某些行。
聚合函数对数据集执行求和操作。
Group by 子句根据在该子句中指定的列将大量数据集分组成较小的数据集。
Having 对较小的数据组执行聚合函数。
Order by 子句确定结果子的排">
<meta property="og:image" content="http://yoursite.com/![](http://chf2012.oss-cn-hangzhou.aliyuncs.com/daily_pic/S软件应用_SQL01.jpg">
<meta property="og:updated_time" content="2018-11-11T14:28:54.262Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL Server_常用查询">
<meta name="twitter:description" content="SQL 逻辑流Select 语法
Select语句的From部分将所有数据源组装进一个结果集，然后由Select语句的剩余部分对结果集执行操作。
Where子句作用于From组装的记录集，根据条件筛选某些行。
聚合函数对数据集执行求和操作。
Group by 子句根据在该子句中指定的列将大量数据集分组成较小的数据集。
Having 对较小的数据组执行聚合函数。
Order by 子句确定结果子的排">
<meta name="twitter:image" content="http://yoursite.com/![](http://chf2012.oss-cn-hangzhou.aliyuncs.com/daily_pic/S软件应用_SQL01.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/03/07/软件应用_程序编程/SQL/SQL-Server/SQL-Server_查询整理/"/>





  <title> SQL Server_常用查询 | Jimmy那些事儿 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jimmy那些事儿</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/07/软件应用_程序编程/SQL/SQL-Server/SQL-Server_查询整理/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jimmy_Cai">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jimmy那些事儿">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jimmy那些事儿" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                SQL Server_常用查询
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-07T00:00:00+08:00">
                2017-03-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新</span>
              
              <time title="更新" itemprop="dateModified" datetime="2018-11-11T22:28:54+08:00">
                2018-11-11
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件应用/" itemprop="url" rel="index">
                    <span itemprop="name">软件应用</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件应用/程序编程/" itemprop="url" rel="index">
                    <span itemprop="name">程序编程</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件应用/程序编程/SQL/" itemprop="url" rel="index">
                    <span itemprop="name">SQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/03/07/软件应用_程序编程/SQL/SQL-Server/SQL-Server_查询整理/" class="leancloud_visitors" data-flag-title="SQL Server_常用查询">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="SQL-逻辑流"><a href="#SQL-逻辑流" class="headerlink" title="SQL 逻辑流"></a>SQL 逻辑流</h2><h3 id="Select-语法"><a href="#Select-语法" class="headerlink" title="Select 语法"></a>Select 语法</h3><ol>
<li>Select语句的<strong>From部分</strong>将所有数据源<strong>组装进一个结果集</strong>，然后由Select语句的剩余部分对结果集执行操作。</li>
<li>Where子句作用于From组装的记录集，根据条件筛选某些行。</li>
<li>聚合函数对数据集执行求和操作。</li>
<li>Group by 子句根据在该子句中指定的列将大量数据集分组成较小的数据集。</li>
<li>Having 对较小的<strong>数据组</strong>执行聚合函数。</li>
<li>Order by 子句确定结果子的排列顺序。默认为升序；</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Select [Distinct] [Top(n)] *, columns, or expressions</div><div class="line">  [From data source(s)]</div><div class="line">    [Join data source</div><div class="line">	  ON condition] (may include multiple joins)</div><div class="line">  [Where conditions]</div><div class="line">  [Group by columns]</div><div class="line">  [Having conditions]</div><div class="line">  [Order by columns];</div></pre></td></tr></table></figure>
 <a id="more"></a>
<h3 id="查询语句的逻辑流"><a href="#查询语句的逻辑流" class="headerlink" title="查询语句的逻辑流"></a>查询语句的逻辑流</h3><p><strong>数据源(From) —— 条件(Where)  —— 列/表达式 (col/exp) —— Order by — 谓词</strong></p>
<ol>
<li><p>From，查询<strong>首先组装初始数据集</strong>。</p>
</li>
<li><p>Where，筛选；筛选过程实际上是<strong>选择符合标准的行的where子句</strong>。</p>
</li>
<li><p><strong>Group by，组合数据的子集</strong>  <u>[若要分组，<strong>先对数据排序</strong>，然后根据排序后的数据进行聚合]</u></p>
</li>
<li><p><strong>聚合，</strong>Aggregations，选择性地对数据进行<strong>聚合</strong>；如求平均值，按列中的值对数据分组以及筛选组；</p>
</li>
<li><p><strong>Having，筛选数据的子集</strong></p>
</li>
<li><p><strong>列表达式</strong>：处理Select列，并计算任何表达式 [ 这个时候才涉及到列 ]</p>
</li>
<li><p>Order by，排序</p>
</li>
<li><p>Over，窗口函数和排名函数通过与其他聚合函数一起提供结果的<strong>单独排序的视图</strong></p>
</li>
<li><p>Distinct，从结果集中删除任何重复的行</p>
</li>
<li><p>Top，<strong>选定行后</strong>，执行计算，<strong>并按所需的顺序排序</strong></p>
</li>
<li><p>Insert,Update,Delete，最后一个逻辑步骤是将数据修改操作应用到查询结果。</p>
</li>
<li><p>Output，选择插入和删除的虚拟表，并返回给客户端</p>
</li>
<li><p>Union，堆叠或合并多个查询的结果</p>
</li>
</ol>
<h3 id="SQL编写标准"><a href="#SQL编写标准" class="headerlink" title="SQL编写标准"></a>SQL编写标准</h3><ol>
<li>若需要多个表合成一个表，必须确定<strong>【唯一标识符】或者说是联接的表，从联接表中去寻找联接的字段</strong><ul>
<li><strong>最后合并的中都必须要有这个字段</strong></li>
</ul>
</li>
<li><strong>若出现多个主条件，先将主条件的区分变量统一到一个表中</strong></li>
<li><strong>其他表与这个表进行联接</strong><ul>
<li>先把各个字段单独用Select写出来</li>
<li>再合并为一个Select语句</li>
</ul>
</li>
</ol>
<h2 id="运算符介绍"><a href="#运算符介绍" class="headerlink" title="运算符介绍"></a>运算符介绍</h2><h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>Not &gt; 算术运算符(+-) &gt; 条件运算符(where) &gt; And &gt; Or</p>
<blockquote>
<p>电脑中字符优先级： 数字&gt;字母</p>
<blockquote>
<p>1a &gt; a1 &gt; a11 &gt; aa1</p>
</blockquote>
</blockquote>
<h3 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>%</td>
<td>任意长度的字符串</td>
<td>Email  <strong>Like</strong> ‘%@%.com’</td>
</tr>
<tr>
<td>‘_’</td>
<td>任意一个字符</td>
<td>AuthorName  Like ‘张_’</td>
</tr>
<tr>
<td>[ ]</td>
<td>在<strong>指定</strong>范围内的任意一个字符</td>
<td>A  Like ‘A6C8[1-5]’</td>
</tr>
<tr>
<td>[^]</td>
<td><strong>不在指定范围内</strong>的任意<strong>一个</strong>字符</td>
<td>A  Like ‘A6C8[^1-6]’</td>
</tr>
</tbody>
</table>
<blockquote>
<p>查找含通配符的表达式：</p>
<ol>
<li>必须使用<strong>Like字符</strong></li>
<li>把通配符放入方括号[ ] 内</li>
<li>在其之前放一个转义符</li>
</ol>
</blockquote>
<h2 id="注意事项与通用规则"><a href="#注意事项与通用规则" class="headerlink" title="注意事项与通用规则"></a>注意事项与通用规则</h2><h3 id="方括号"><a href="#方括号" class="headerlink" title="方括号 [ ]"></a>方括号 [ ]</h3><ul>
<li>why  ：表名或字段名如果引用了sql server中的关键字，数据库会不识别这到底是关键字还是<strong>表名</strong>（还是<strong>字段名</strong>）时就必须要加；<ul>
<li><strong>查询语句的表中加上方括号[ ] ， 目的是以声明其不是保留字</strong> ；</li>
<li>如果表名不是关键字，不用加方括号</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 一个表名叫user，user在sqlserver中属于关键字，那么查询的时候必须要这样</div><div class="line">select * from [user] ;</div><div class="line"></div><div class="line"># 若表名user中没有user的列，则无需加方括号</div><div class="line">select * from user ;</div></pre></td></tr></table></figure>
<h3 id="合并：字段-表格"><a href="#合并：字段-表格" class="headerlink" title="合并：字段+表格"></a>合并：字段+表格</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 字段合并 +</div><div class="line">SELECT 机构+客户名称  FROM allzjb  where 结算日期&gt;&apos;2015-11-15&apos;</div><div class="line"></div><div class="line">SELECT RTRIM(LastName) + &apos;,&apos; + SPACE(2) +  LTRIM(FirstName) FROM Person.Person</div><div class="line">--剪裁姓氏，并将逗号、两个空格和 Person 中的 AdventureWorks2012 表列出的人员名字串联起来</div></pre></td></tr></table></figure>
<p>使用<strong>“ + ”</strong>连接多个字段，<strong>合并成一列</strong> </p>
<blockquote>
<ul>
<li>前后类型应兼容；</li>
</ul>
<blockquote>
<p>如果+连接数值类型，结果是数值之和</p>
<p>如果+连接字符串类型，结果是字符串的连接</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 表格合并 - insert into A1 select ... </div><div class="line">INSERT INTO table2 SELECT * FROM table1;  -- 把table1的数值插入到table2中</div><div class="line"></div><div class="line"># 只插入某一列的值</div><div class="line">INSERT INTO table2 (column_name) </div><div class="line">  SELECT column_name FROM table1 ;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 合并为一个字符串 - concat()</div><div class="line">Select Concat(Null, &apos;Patrick &apos;, 1, &apos; LeBlacn&apos;)</div><div class="line">--隐式地将所有值转换为字符串，将空值转为空字符串</div></pre></td></tr></table></figure>
<h3 id="Where条件"><a href="#Where条件" class="headerlink" title="Where条件"></a>Where条件</h3><ul>
<li><strong>最佳实践</strong>：找到事物的最好办法就是查找，而不是先排除不是该事物的所有东西。<strong>即where条件，声明肯定的限制条件优于否定的限制条件；</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">where col &gt;= 10 ;  优于 where col !&lt; 9</div></pre></td></tr></table></figure>
<blockquote>
<p>惊叹号! ，不是ANSI标准的SQL；</p>
</blockquote>
<ul>
<li><strong>布尔逻辑运算的优先次序： NOT &gt; AND &gt; OR</strong><ul>
<li>若where子句中同时出现 and 和 or 条件，<strong><u>一定要把整个or条件子句用括号括起来</u></strong></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Where name Like &apos;Chain%&apos; or ProductID Between 320 And 324 </div><div class="line">  And name Like &apos;%s%&apos;  </div><div class="line">--1. 先执行And，即找出name中 带有 s 的名字；</div><div class="line">--2. 再在其中寻找 name中有Chain 或者 ProduceID在[320,324]</div><div class="line"></div><div class="line">------------------</div><div class="line">Where (name Like &apos;Chain%&apos; or ProductID Between 320 And 324 )</div><div class="line">  And name Like &apos;%s%&apos;</div><div class="line">--1. 先执行括号，即先找出name中有Chain 或者 ProduceID在[320,324]</div><div class="line">--2. 再在其中找出name中 带有 s 的名字；</div></pre></td></tr></table></figure>
<blockquote>
<p>不能在Where 子句中使用聚合函数。此时应用<strong>子查询</strong>来进行限定</p>
</blockquote>
<ul>
<li><strong>先进行联合，再进行where条件的执行</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Select * From A </div><div class="line">  Left Join B On A.name = B.name   ----因为先进行联合，再进行where条件选择，若在表B中存在不满足where条件的观测值，最后不会被选中</div><div class="line">  Where B.col = &apos;x&apos;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Between-and"><a href="#Between-and" class="headerlink" title="Between and"></a>Between and</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 使用带有日期时间值的 BETWEEN </div><div class="line">WHERE RateChangeDate BETWEEN &apos;2001-12-12&apos; AND &apos;2002-01-05&apos;;   </div><div class="line"></div><div class="line"># 特别注意，若涉及到最小单位为小时的情况，则必须考虑多加一天；</div><div class="line">BETWEEN &apos;2001-12-12&apos; AND &apos;2002-01-05&apos;;  </div><div class="line"># 表示选择的范围为 2001-12-12 00:00:00 ~ 2002-01-05 00:00:00 ; 1月5日的 09:00:00是不包含在内的【即1月5日的不包含】</div><div class="line"></div><div class="line">----上面的示例检索所在的行【datetime值】可以介于&apos;20011212&apos;和&apos;20020105&apos;(含） 之间;因为在查询中的日期值和datetime值存储在RateChangeDate而无需在日期的时间部分中指定了列。</div><div class="line">-- 下面是结果集：</div><div class="line">BusinessEntityID RateChangeDate</div><div class="line">3 2001-12-12 00:00:00.000</div><div class="line">4 2002-01-05 00:00:00.000</div><div class="line">----未指定时间部分时，将默认使用 12:00 A.M。 </div><div class="line">--请注意，若某行的时间部分晚于 2002-01-05 12:00 A.M.， 则由于它处于范围之外，因此此查询不返回该行。</div><div class="line"></div><div class="line"></div><div class="line">Select Distinct 结算日期 </div><div class="line">  From [exchange].[GFFCC_YTX].[v_jsmx]</div><div class="line">  Where 结算日期 between &apos;2017/6/12&apos; and &apos;2017/6/15&apos;</div><div class="line">  order by 结算日期</div><div class="line"></div><div class="line">--返回的结果为</div><div class="line">2017-06-12,2017-06-13,2017-06-14   --返回的日期不包括6月15日，因为该表达式表示为 小于等于 2017-06-15 00:00</div></pre></td></tr></table></figure>
<h3 id="ALL、SOME、ANY"><a href="#ALL、SOME、ANY" class="headerlink" title="ALL、SOME、ANY"></a>ALL、SOME、ANY</h3><ol>
<li>ALL，相当于And；如果子查询可能返回一个空值，那么使用ALL会判断为fasle，使用时要小心；</li>
</ol>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><ul>
<li><strong>一个if，一个命令的执行</strong>；并且<strong>没有Then和End来终止if命令；</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">If condition </div><div class="line">Statement;</div><div class="line"></div><div class="line">----------------------------------</div><div class="line">If 1=0</div><div class="line">Print &apos;Line one&apos;;</div><div class="line">Print &apos;Line two&apos;;</div><div class="line"></div><div class="line">--结果返回Line two；</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>if语句之后没有分号</strong>； if语句实际上是后面语句的提前；</p>
</blockquote>
<ol>
<li><strong>使用Begin / End 有条件地执行多条语句</strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">If condition </div><div class="line">  Begin;</div><div class="line">	Multipie Line;</div><div class="line">  End;  --每个都有分号</div></pre></td></tr></table></figure>
<ol>
<li><strong>使用If Exists()作为基于存在性的条件</strong></li>
</ol>
<ul>
<li>If Exists() 结构使用从SQL Select语句<strong>返回的每一行作为条件。</strong><ul>
<li>因为If Exists() 结构会查找每一行，所以Select语句应当选择所有的列。一<strong>旦一个单行满足了If Exists()，查询就会继续执行</strong></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">If Exists</div><div class="line">  (Select * From production.product Where quantity = 0)</div><div class="line">  Begin;</div><div class="line">	Print &apos;Relpenish Inventory&apos;;</div><div class="line">  End;</div></pre></td></tr></table></figure>
<ol>
<li><strong>使用If / Else 执行替换语句</strong></li>
</ol>
<ul>
<li>可选的Else定义了if条件为False时的执行代码；Else可控制<strong>下一个单个命令，后者Begin/End块</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">If condition</div><div class="line"> 	 Single line or Begin/End block of code;</div><div class="line">  Else</div><div class="line">	Single line or Begin/End block of code;</div></pre></td></tr></table></figure>
<h4 id="while-break-continue的使用"><a href="#while-break-continue的使用" class="headerlink" title="while,break,continue的使用"></a><strong>while,break,continue的使用</strong></h4><ul>
<li>设置重复执行 SQL 语句或语句块的条件。<strong>只要指定的条件为真</strong>，就重复执行语句。可以使用 BREAK 和 CONTINUE 关键字在<strong>循环内部控制 WHILE 循环</strong>中语句的执行。 </li>
<li><strong>Break</strong> ：导致<strong>从最内层的WHILE循环中退出</strong>。将<strong>执行出现在END关键字后面的任何语句</strong>，END 关键字为循环结束标记。<ul>
<li>如果嵌套了两个或多个 WHILE 循环，内层的 BREAK 将导致退出到下一个外层循环。<strong>首先运行内层循环结束之后的所有语句，然后下一个外层循环重新开始执行。</strong> </li>
</ul>
</li>
<li><strong>Continue</strong> ：使 WHILE 循环<strong>重新开始</strong>执行，<strong>忽略 CONTINUE 关键字后的任何语句</strong>。 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">while  当条件为ture时循环代码；</div><div class="line"></div><div class="line">----</div><div class="line">WHILE Boolean_expression </div><div class="line">&#123; sql_statement | statement_block &#125;   --若有Select语句，必须用圆括号（） --若要定义语句块，请使用控制流关键字 BEGIN 和 END。 </div><div class="line">[ BREAK ]  --导致从最内层的WHILE循环中退出。将执行出现在END关键字后面的任何语句，END 关键字为循环结束标记。  --如果嵌套了两个或多个 WHILE 循环，内层的 BREAK 将导致退出到下一个外层循环。首先运行内层循环结束之后的所有语句，然后下一个外层循环重新开始执行。 </div><div class="line">&#123; sql_statement | statement_block &#125; </div><div class="line">[ CONTINUE ] -- 使 WHILE 循环重新开始执行，忽略 CONTINUE 关键字后的任何语句。 </div><div class="line"></div><div class="line"></div><div class="line">-----------------------------------------------------------------------------</div><div class="line">A. 在嵌套的 IF...ELSE 和 WHILE 中使用 BREAK 和 CONTINUE </div><div class="line">如果平均价格少于 $30，WHILE 循环就将价格加倍，然后选择最高价。如果最高价少于或等于 $50，WHILE 循环重新启动并再次将价格加倍。该循环不断地将价格加倍直到最高价格超过 $50，然后退出 WHILE 循环并打印一条消息。</div><div class="line">USE pubs </div><div class="line">GO </div><div class="line">while (select avg(price) from titles) &lt;$30 </div><div class="line">begin</div><div class="line"> update titles</div><div class="line">  set price=price*2</div><div class="line">  select max(price) from titles</div><div class="line">  if(select max(price) from titles) &gt;$50</div><div class="line">break</div><div class="line">  else</div><div class="line">continue</div><div class="line">end</div><div class="line">print &apos;too much for the marker to bear&apos; </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">B. 在带有游标的过程中使用 WHILE </div><div class="line">declare @i int </div><div class="line">set @i=1 </div><div class="line"></div><div class="line">while @i&lt;30 </div><div class="line">begin </div><div class="line">insert into test (userid) values(@i) </div><div class="line">set @i=@i+1 </div><div class="line">end</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="创建与变更格式"><a href="#创建与变更格式" class="headerlink" title="创建与变更格式"></a>创建与变更格式</h2><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">----创建 视图</div><div class="line">Create View schemaname.viewname[(column)]</div><div class="line">As</div><div class="line">Select ...From ...;</div><div class="line"></div><div class="line">----删除视图</div><div class="line">Drop View name</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="变更格式"><a href="#变更格式" class="headerlink" title="变更格式"></a>变更格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">----变更列的类型</div><div class="line">ALTER TABLE table_name</div><div class="line">ALTER COLUMN column_name data_type</div><div class="line"></div><div class="line">----添加新列</div><div class="line">1 ALTER TABLE table_name</div><div class="line">2 ADD column_name data_type NULL  -- 表示 允许为NUll</div><div class="line"></div><div class="line">----删除某列</div><div class="line">ALTER TABLE table_name</div><div class="line">DROP COLUMN [COLUMN_NAME]  --drop column set4_time</div><div class="line"></div><div class="line">----重命名列名   下面的示例将 TerritoryID 表中的 Sales.SalesTerritory 列重命名为 TerrID。</div><div class="line">EXEC sp_rename &apos;Sales.SalesTerritory.TerritoryID&apos;, &apos;TerrID&apos;, &apos;COLUMN&apos;;  </div><div class="line"></div><div class="line">----重命名表</div><div class="line">exec sp_rename &apos;[原表名]&apos;,&apos;[新表名]&apos;</div><div class="line"></div><div class="line">----添加主键</div><div class="line">Alter table [表名] add constraint [ 约束名] primary key( [列名])</div><div class="line"></div><div class="line">----添加唯一约束</div><div class="line">Alter table [表名] add constraint [ 约束名] unique([列名])</div><div class="line"></div><div class="line">----添加表中某列的默认值</div><div class="line">Alter table [表名] add constraint [约束名] default(默认值) for [列名]</div><div class="line"></div><div class="line">----添加外键约束</div><div class="line">Alter table [表名] add constraint [约束名]  foreign key(列名) referencese 另一表名(列名)</div><div class="line"></div><div class="line">----删除约束</div><div class="line">Alter table [表名] drop constraint [约束名]</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="插入、更新、删除、合并数据"><a href="#插入、更新、删除、合并数据" class="headerlink" title="插入、更新、删除、合并数据"></a>插入、更新、删除、合并数据</h2><h3 id="创建数据"><a href="#创建数据" class="headerlink" title="创建数据"></a>创建数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Create Table table.name(</div><div class="line">col_name1 [Int] Identity(1,1) Not Null, </div><div class="line">col_name2 datetime,</div><div class="line">Constraint PK_table.name_col_name1 Primary Key CLUSTERED (col_name1))</div><div class="line"> --IDENTITY [ (seed , increment) ]  --在表中创建一个标识列。 --seed,第一行所用的值； increment,增量值</div></pre></td></tr></table></figure>
<blockquote>
<p>若要重新定义主键，则必须首先删除与现有主键之间的任何关系，然后才能创建新主键。 此时，将显示一条消息警告您：作为该过程的一部分，将自动删除现有关系。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--创建新列</div><div class="line">ALTER TABLE dbo.doc_exa ADD column_b VARCHAR(20) NULL, column_c INT NULL ;</div></pre></td></tr></table></figure>
<br>

<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># 插入简单的值行</div><div class="line">Insert [Into] schema.table [ (colums, ...) ]</div><div class="line">  Values (value,...),</div><div class="line">	(value,...);</div><div class="line"></div><div class="line"># 在标识列中插入数据，要使用Set Identity_insert on / off关键字</div><div class="line">Set Identity_insert dbo.address On</div><div class="line">  Insert Into dbo.address (AddreddID, Addressl, city, state, county)</div><div class="line">  Valuse(999, )</div><div class="line">Set Identity_insert dbo.address Off</div><div class="line"></div><div class="line"></div><div class="line">------------------------------------------------------------------------------------</div><div class="line"># 从Select语句中插入结果集</div><div class="line">Insert [Into] schema.table [ (colums,...)]</div><div class="line">  Select columns From data [Where conditions];</div><div class="line">--1. schema.table 必须存在</div><div class="line">--2. into schema.table中的列必须与之后Select中的列相同</div><div class="line">--3. 若schema.table中有5列，只选取其中3列插入，则其他2列的观测值对NULL</div><div class="line"></div><div class="line"></div><div class="line">------------------------------------------------------------------------------------</div><div class="line"># 从存储过程插入结果集</div><div class="line">Insert [Into] schema.table [ (colums,...)]</div><div class="line">  Execute storedprocedure;</div></pre></td></tr></table></figure>
<p>–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 在插入数据时创建表</div><div class="line">Select colums </div><div class="line">  Into newtable From data [where conditions];</div></pre></td></tr></table></figure>
<blockquote>
<p>SQL中合并列，只要选择对应的列即可</p>
<p><code>Select a.*, b.* From a Full Join b</code></p>
</blockquote>
<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 更新单个表</div><div class="line">Update schema.table</div><div class="line">  Set column = expression,</div><div class="line">	column = value </div><div class="line">  [From data]</div><div class="line">  [Where conditions];</div><div class="line"></div><div class="line"></div><div class="line">----------------------------------------------------------------------------------</div><div class="line"># 执行全局搜索与替代</div><div class="line"># replace(data, &apos;aaa&apos;, &apos;bbb&apos;)</div><div class="line">Update address</div><div class="line">  Set county = Replace(county, &apos;sun&apos;, &apos;dark&apos;)  -- 将county列中所有的sun替换为dark</div><div class="line">  Where county Like &apos;%shine&apos; ;</div></pre></td></tr></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># delete</div><div class="line">Delete [From] schema.table</div><div class="line">  /*[From data] SQL Server 特有的T-SQL扩展，用来进行联接；正常情况下应在where子句中创建子查询*/</div><div class="line">  [Where conditions];</div><div class="line"></div><div class="line"># 删除所有行</div><div class="line">Delete From schema.table</div><div class="line">--不删除表的情况下删除所有的行。这意味着表的结构、属性和索引都是完整的：</div><div class="line"></div><div class="line">---------------------------------------------------------------------------------</div><div class="line"># 删除表中所有行 - truncate</div><div class="line">Truncate Table dbo.address</div><div class="line"></div><div class="line">---------------------------------------------------------------------------------</div><div class="line"># 删除整个表</div><div class="line">Drop table schema.table</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>truncate 、delete与drop区别</strong></p>
</blockquote>
<ul>
<li><strong>相同点</strong></li>
</ul>
<ol>
<li>truncate和不带where子句的delete、以及drop都会删除表内的数据drop、truncate都是DDL语句(数据定义语言)，执行后会自动提交。Delete是DML语句(数据库操作语言)</li>
</ol>
<ul>
<li><strong>不同点</strong></li>
</ul>
<ol>
<li><p><strong>truncate 和 delete</strong> 只删除数据<strong>不删除表的结构(定义)</strong>；<strong>drop 语句将删除表的结构</strong>被依赖的约束(constrain)、触发器(trigger)、索引(index)；依赖于该表的存储过程/函数将保留,但是变为 invalid 状态。</p>
</li>
<li><p>delete 语句是数据库操作语言(dml)，这个操作会放到 rollback segement 中，事务提交之后才生效；如果有相应的 trigger，执行的时候将被触发。<strong>truncate、drop 是数据库定义语言(ddl)，操作立即生效，原数据不放到 rollback segment 中，不能回滚，操作不触发 trigger。</strong></p>
</li>
<li><p>delete 语句不影响表所占用的 extent，高水线(high watermark)保持原位置不动。drop 语句将表所占用的空间全部释放。truncate 语句缺省情况下见空间释放到 minextents个 extent，除非使用reuse storage；truncate 会将高水线复位(回到最开始)。</p>
</li>
<li><p><strong>速度：drop&gt; truncate &gt; delete</strong></p>
<ul>
<li>TRUNCATE TABLE在功能上与不带WHERE子句的DELETE语句相同：二者均删除表中的全部行。但TRUNCATE  TABLE   比DELETE速度快，且使用的系统和事务日志资源少。DELETE   语句每次删除一行，并在事务日志中为所删除的每行记录一项。TRUNCATE   TABLE   通过释放存储表数据所用的数据页来删除数据，并且只在事务日志中记录页的释放。</li>
</ul>
</li>
<li><p>安全性：</p>
<ul>
<li><strong>想保留表而将所有数据删除，如果和事务无关，用truncate即可。如果和事务有关,或者想触发trigger,还是用delete。</strong></li>
</ul>
</li>
</ol>
<ul>
<li><strong>小心使用 drop 和 truncate，尤其没有备份的时候</strong></li>
<li>使用上，想删除部分数据行用 delete，注意带上where子句. 回滚段要足够大<ul>
<li>想删除表,当然用 drop</li>
</ul>
</li>
</ul>
<ol>
<li>对于由FOREIGN   KEY 约束引用的表，不能使用TRUNCATE  TABLE，而应使用不带WHER 子句的DELETE语句。由于   TRUNCATE   TABLE不记录在日志中，所以它不能激活触发器。</li>
<li>TRUNCATE   TABLE不能用于参与了索引视图的表。</li>
</ol>
<p><br></p>
<h4 id="判断是否存在后删除"><a href="#判断是否存在后删除" class="headerlink" title="判断是否存在后删除"></a>判断是否存在后删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">----临时表</div><div class="line">if Object_id(N&apos;tempdb.dbo.#a4&apos;,N&apos;U&apos;) Is Not Null</div><div class="line">  Drop table #a5</div><div class="line"></div><div class="line">----判断数据表是否存在,若存在则删除数据表</div><div class="line">IF EXISTS (SELECT * FROM sys.objects WHERE name = &apos;Table_Name&apos;) DROP TABLE Table_Name;</div></pre></td></tr></table></figure>
<h3 id="合并数据"><a href="#合并数据" class="headerlink" title="合并数据"></a>合并数据</h3><ul>
<li>Meger语句。使用 MERGE 语句在一条语句中执行插入、更新或删除操作。<ul>
<li><strong>有条件地在目标表中插入或更新行。</strong><ul>
<li><strong>如果目标表中存在相应行，则更新一个或多个列；否则，会将数据插入新行。</strong></li>
</ul>
</li>
<li><strong>同步两个表。</strong>根据<strong>与源数据的差别在目标表中插入、更新或删除行。</strong></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Meger flightpassengers As f         -- MERGE 子句用于指定作为插入、更新或删除操作目标的表或视图</div><div class="line">  Using checkin as c                --USING 子句用于指定要与目标联接的数据源</div><div class="line">	On c.lastname = f.lastname      --ON 子句用于指定决定目标与源的匹配位置的联接条件</div><div class="line">	And c.firstname = f.firstname</div><div class="line">	And c.flightcode = f.flightcode</div><div class="line">	And c.flightdate = f.flightdate</div><div class="line">  When Matched </div><div class="line">	Then Update Set f.seat = c.seat</div><div class="line">  When Not Matched By Target        --当Soucre表与Target表（基准表）不匹配时，对Target表进行操作</div><div class="line">	Then Insert (Firsrname, Lastname, Flightcode, flightdate, seat)</div><div class="line">  When Not Matched By Source        --当Target表与Soucre表（基准表）不匹配时，对Target表进行操作【相同】</div><div class="line">	Then Delete;</div><div class="line"></div><div class="line">--WHEN 子句（WHEN MATCHED、WHEN NOT MATCHED BY TARGET 和 WHEN NOT MATCHED BY SOURCE）基于 ON 子句的结果和在 WHEN 子句中指定的任何其他搜索条件指定所要采取的操作。</div><div class="line">--OUTPUT 子句针对插入、更新或删除的目标中的每一行返回一行。</div><div class="line"></div><div class="line">--必须由分号进行终止</div><div class="line">--必须是一对一匹配；一对多匹配是不允许的</div><div class="line">--联接条件必须是确定性的，也就是可重复的</div></pre></td></tr></table></figure>
<h3 id="返回修改后的数据"><a href="#返回修改后的数据" class="headerlink" title="返回修改后的数据"></a>返回修改后的数据</h3><ul>
<li>Output子句可以访问<strong>插入的和删除的虚拟表，</strong>以及任何在From自引用的数据源来选择要返回的数据。</li>
</ul>
<blockquote>
<p>Output子句有一个较为高级的应用，可以把输出数据传输到外查询。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"># 从插入返回数据</div><div class="line">Insert Into personlist</div><div class="line">  Output Inserted.*    -- Inserted.</div><div class="line">  Valuse(7777, &apos;Jane&apos;, &apos;Doe&apos;);</div><div class="line"></div><div class="line"></div><div class="line"># 从更新返回数据 -- 可同时返回更新前、更新后的数据</div><div class="line">Update personlist</div><div class="line">  Set firstname = &apos;Jane&apos;, Lastname = &quot;Doe&quot;</div><div class="line">  Output Deleted.firstname oldfirstname, Deleted.lastname oldflastname,  --Deleted.column oldcolumn</div><div class="line">         Inserted.firstname newfirstname, Inserted.lastname newlastname</div><div class="line">  Where businessentityID = 7777</div><div class="line"></div><div class="line"></div><div class="line"># 从删除返回数据</div><div class="line">Delete From personlist</div><div class="line">  Output Deleted.*</div><div class="line">  Where ...</div><div class="line"></div><div class="line"></div><div class="line"># 从合并返回数据</div><div class="line">...</div><div class="line">  Output deleted.column, deleted.column,</div><div class="line">         $action,                             -- 显示数据库操作的行为（为Insert、Delete、Update)</div><div class="line">		inserted.column, inserted.column ;</div><div class="line"></div><div class="line"></div><div class="line"># 把数据库返回到表中</div><div class="line">Declare @Deletedperson Table(</div><div class="line">  businessentityID Int Not Null Primary Key,</div><div class="line">  lastname Varchar(50) Not Null,</div><div class="line">  firstname Varchar(50) Not Null</div><div class="line">)</div><div class="line"></div><div class="line">Delete dbo.personlist</div><div class="line">  Output Deleted.colunm, Deleted.column</div><div class="line">  Into @Deletedperson</div><div class="line">  Where bussinessentityID = 2;</div></pre></td></tr></table></figure>
<h2 id="1-查询：字符串"><a href="#1-查询：字符串" class="headerlink" title="1. 查询：字符串"></a>1. 查询：字符串</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>功能描述</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>LEN</td>
<td>返回指定字符串的字符个数(而不是字节)，其中<strong>不包含尾随空格</strong></td>
<td>SELECT  LEN(‘李丽然作者’)  返回:5</td>
</tr>
<tr>
<td>DATALENGTH</td>
<td>返回指定字符串的字节数</td>
<td>SELECT  DATALENGTH(‘中国人’)  返回：6</td>
</tr>
<tr>
<td>UPPER</td>
<td>将小写字符转换成大写字符</td>
<td>SELECT  UPPER(‘book图书表’)  返回:BOOK图书表</td>
</tr>
<tr>
<td>LTRIM</td>
<td>返回去掉左侧空格的字符串</td>
<td>SELECT  LTRIM(‘  Authors’)  返回:  Authors</td>
</tr>
<tr>
<td>CHARINDEX</td>
<td>查找一个指定的字符串在另一个字符串中的起始位置</td>
<td>SELECT  CHARINDEX(‘L’, ‘HELLO’, 1)  返回:3</td>
</tr>
<tr>
<td>LEFT</td>
<td>返回字符串中从左边开指定个数的字符</td>
<td>SELECT  LEFT(‘zhangsan’,  2)  返回:zh</td>
</tr>
<tr>
<td>Substring</td>
<td>返回字符串的一部分：从字符串串的<strong>起始位置连续取指定个数的子串</strong></td>
<td>SELECT  SUBSTRING(‘我爱我的家乡’,3,  2)  返回：我的</td>
</tr>
<tr>
<td>Replace</td>
<td>替换一个字符串中的字符</td>
<td>SELECT  REPLACE(‘我爱我的家乡家乡’,  ‘家乡’,  ‘学校’)  返回:  我爱我的学校学校</td>
</tr>
<tr>
<td>Stuff</td>
<td>将一个字符中删除指定数量的字符，并插入另一个字符</td>
<td></td>
</tr>
<tr>
<td>Concat</td>
<td>将多个字符串组合为单个字符串</td>
</tr>
</tbody>
</table>
<blockquote>
<p>使用字符串字面量时，通过输入两个单引号转化为一个单引号</p>
<blockquote>
<p>Replace(name, ‘’’’, ‘’) ; Life’’s Great! 被解释为 Life’s Great!</p>
</blockquote>
</blockquote>
<h4 id="行数-amp-字符数"><a href="#行数-amp-字符数" class="headerlink" title="行数&amp;字符数"></a>行数&amp;字符数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 返回观测值的行数 - count [非空值的个数]</div><div class="line">SELECT COUNT(name) FROM my_contacts;</div><div class="line"></div><div class="line"># 返回字符串的字符个数 - len</div><div class="line">SELECT LEN(&apos;中国人&apos;) ;  # 返回:3</div><div class="line"></div><div class="line"># 返回字符串的字节数 - datalength</div><div class="line">SELECT DATALENGTH(&apos;中国人&apos;);  # 返回：6</div></pre></td></tr></table></figure>
<h4 id="去空格"><a href="#去空格" class="headerlink" title="去空格"></a>去空格</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 去空格 - ltrim / rtrim</div><div class="line">select ltrim(rtrim(&apos; &quot;左右都没有空格&quot;  &apos;));  # 左右去空格</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 生成空格 - space</div><div class="line">select space(2);  # 生成2个空格</div><div class="line"></div><div class="line">SELECT RTRIM(LastName) + &apos;,&apos; + SPACE(2) +  LTRIM(FirstName) FROM Person.Person</div><div class="line"># 剪裁姓氏，并将逗号、两个空格和 Person 中的 AdventureWorks2012 表列出的人员名字串联起来</div></pre></td></tr></table></figure>
<h4 id="取子串"><a href="#取子串" class="headerlink" title="取子串"></a>取子串</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 取子串：特定位置 - substring</div><div class="line">select substring(name,1,2);  # 返回na;</div><div class="line"></div><div class="line"></div><div class="line"># 取子串：左/右 - left /right</div><div class="line">select left(ltrim( name), 3);  # 返回nam;</div><div class="line"></div><div class="line"></div><div class="line">-------结合Charindex 返回特定符号之前的值</div><div class="line">Select left(&apos;text&apos;, charindex(&apos;%&apos;,&apos;text&apos;,1)-1)  -- 第二个为返回 % 出现的位置</div><div class="line">Select left(&apos;text&apos;, len(&apos;text&apos;)-1 ) --若指定符号为最后一个时</div></pre></td></tr></table></figure>
<h4 id="返回特定位置"><a href="#返回特定位置" class="headerlink" title="返回特定位置"></a>返回特定位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 返回位置：起始位置 - charindex</div><div class="line">select charindex(&apos;L&apos;, &apos;HELLO&apos;, 1);  # 返回:3; 1表示从第一个位置开始选取</div><div class="line">--charindex(serach string, string ,starting position) ；第三个参数默认为1，可不写</div><div class="line"></div><div class="line"># 返回位置：表达式中某模式第一次出现的起始位置 - patindex</div><div class="line">patindex(&apos;%123%&apos;,&apos;abc123def&apos;);  # 返回4</div><div class="line">--允许通配符的使用</div><div class="line"></div><div class="line">--返回第一个数字的位置</div><div class="line">Select patindex(&apos;%[0-9]%&apos;,&apos;字段名&apos;)</div><div class="line"></div><div class="line">--返回第一个数字的位置，并进行截取</div><div class="line">substring(合约,1,patindex(&apos;%[0-9]%&apos;,合约)-1),</div></pre></td></tr></table></figure>
<h5 id="取出一个字符串中最后一个特殊字符右边的字符"><a href="#取出一个字符串中最后一个特殊字符右边的字符" class="headerlink" title="取出一个字符串中最后一个特殊字符右边的字符"></a>取出一个字符串中最后一个特殊字符右边的字符</h5><ul>
<li>涉及 翻转 <code>reverse</code>  和 <code>charindex</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">DECLARE @aa VARCHAR(30)</div><div class="line">SET @aa = &apos;10*20*300&apos;</div><div class="line"></div><div class="line">-- 取最后一个*后的所有字符</div><div class="line">SELECT RIGHT(@aa, CHARINDEX(&apos;*&apos;,REVERSE(@aa)) - 1) </div><div class="line"></div><div class="line">-- 取定长字符串，如*后的3个字符</div><div class="line">SELECT SUBSTRING(@aa, LEN(@aa) - CHARINDEX(&apos;*&apos;,REVERSE(@aa)) + 2, 3)</div></pre></td></tr></table></figure>
<p><br></p>
<h4 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 替换 - replace</div><div class="line">select replace(&apos;abcdef&apos;,&apos;cde&apos;,&apos;xxx&apos;); 返回 abxxxf</div><div class="line"></div><div class="line">Update address</div><div class="line">  Set country = replace(County, &apos;sun&apos;, &apos;dark&apos;) </div><div class="line">--colname列中每个单元格的aaa值替换为bbb值，并返回colname列</div><div class="line"></div><div class="line"></div><div class="line"># 删除&amp;替换 - stuff()</div><div class="line">Select stuff(&apos;abcdef&apos;, 3, 2, &apos;123&apos;)  -- 返回ab123ef；从第三个位置开始删除2个字符，并插入123</div><div class="line">--stuff(string, insertion position, delete count, string inserted);</div></pre></td></tr></table></figure>
<h4 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 合并为一个字符串 - concat()</div><div class="line">Select Concat(Null, &apos;Patrick &apos;, 1, &apos; LeBlacn&apos;)</div><div class="line">--隐式地将所有值转换为字符串，将空值转为空字符串</div></pre></td></tr></table></figure>
<h4 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 转换：大小写 - upper/lower</div><div class="line">select upper(&apos;abc&apos;);  # 返回 ABC</div><div class="line"></div><div class="line"># 转换：反转 - reverse</div><div class="line">select reverse(&apos;abc&apos;);  # 返回&apos;cba&apos;</div><div class="line"></div><div class="line"># 转换：字符形式 - char</div><div class="line">select char(213);</div><div class="line"></div><div class="line"># 转换：字符串形式 - str</div><div class="line">select str(123.45, 6,1);  # 把数值转换成字符串格式</div><div class="line">--返回123.5； 将123.45转为6个位置的字符串，数字的小数部分舍入为1为小数；</div><div class="line"></div><div class="line"># 转换：ascii码 - ascii</div><div class="line">select ascii(123) as &apos;123&apos;</div></pre></td></tr></table></figure>
<h4 id="格式转换-Convert"><a href="#格式转换-Convert" class="headerlink" title="格式转换 - Convert"></a>格式转换 - Convert</h4><ul>
<li>CONVERT (data_type[(length)], expression [, style])</li>
</ul>
<blockquote>
<p>length： nchar、nvarchar、char、varchar、binary 或 varbinary 数据类型的可选参数。</p>
<p><strong>style：</strong>日期格式样式，借以将 datetime 或 smalldatetime 数据转换为字符数据（nchar、nvarchar、char、varchar、nchar 或 nvarchar 数据类型）；或者字符串格式样式，借以将 float、real、money 或 smallmoney 数据转换为字符数据（nchar、nvarchar、char、varchar、nchar 或 nvarchar 数据类型）。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"># 格式的转换、显示 - convert : 将第2个参数转换为第1个参数所指定的类型 / 用不同的格式显示日期/时间数据。</div><div class="line">-- CONVERT (data_type[(length)], expression [, style]) ;</div><div class="line">-- [,style] 日期格式样式</div><div class="line"></div><div class="line">--------------------日期转换------------------------</div><div class="line">SELECT CONVERT(DateTime, &apos;2020-09-09&apos;);  # 返回: 2020-09-09 00:00:00.000</div><div class="line"></div><div class="line">SELECT CONVERT(varchar(5), 92.89);  # 返回：92.89</div><div class="line"></div><div class="line">SELECT CONVERT(varchar(11), GETDATE(), 121);  # 返回：2010-03-24</div><div class="line">常用日期格式：</div><div class="line">  - 23 ：日期格式 yy-mm-dd</div><div class="line">  - 111：日期格式 yy/mm/dd</div><div class="line">  - 120：日期格式 yyyy-mm-dd hh:mi:ss(24h)</div><div class="line">  - 121：日期格式 yyyy-mm-dd hh:mi:ss.mmm(24h)</div><div class="line"></div><div class="line">  - 105：日期格式 dd-mm-yy</div><div class="line">  - 110：日期格式 mm-dd-yy</div><div class="line"></div><div class="line"></div><div class="line">-------------------其他格式转换-------------------</div><div class="line">Select Convert(int, &apos;3&apos;)</div><div class="line"></div><div class="line">Select COnvert()</div></pre></td></tr></table></figure>
<blockquote>
<p>Data_type : INT / DECIMAL(10,2) / CHAR() / VARCHAR() / </p>
</blockquote>
<p> <br></p>
<h4 id="格式转换-Cast"><a href="#格式转换-Cast" class="headerlink" title="格式转换  - Cast"></a>格式转换  - Cast</h4><ul>
<li>CAST ( expression AS data_type )<ul>
<li>data_type 目标系统所提供的数据类型，包括 bigint 和 sql_variant。不能使用用户定义的数据类型。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select CAST(&apos;123&apos; as int)   -- 123</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="字符串-正则表达式"><a href="#字符串-正则表达式" class="headerlink" title="字符串 - 正则表达式"></a>字符串 - 正则表达式</h2><ul>
<li><strong>regexp_like(x,pattern[,match_option])</strong> ：查看x是否与pattern相匹配</li>
</ul>
<blockquote>
<p>可选的参数match_option字符串说明默认的匹配选项。match_option的取值如下:</p>
<blockquote>
<p>‘c’   说明在进行匹配时区分大小写（缺省值）；<br> ‘i’   说明在进行匹配时不区分大小写；<br> ‘n’   (.)点号能表示所有单个字符,包括换行(俺还不知道什么地方有用到换行.只知道sql里面可以用chr(10)表示换行.<br> ‘m’   字符串存在换行的时候当作多行处理.这样$就可匹配每行的结尾.不然的话$只匹配字符串最后的位置.</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--可以查找ename中以a开头以n结尾的行</div><div class="line">select * from emp</div><div class="line">	where regexp_like(ename,&apos;^a[a-z]*n$&apos;);</div><div class="line"></div><div class="line">--例如ename为arwen或arwin或anden.但Arwen不能被匹配.因为默认是区分大小写.如果是</div><div class="line">select * from emp </div><div class="line">	where regexp_like(ename,&apos;^a[a-z]*n$&apos;,&apos;i&apos;)--则可以查找ename为Arwen的行记录.</div></pre></td></tr></table></figure>
<ul>
<li><strong>regexp_replace</strong></li>
<li><strong>regexp_substr</strong></li>
<li><strong>regexp_instr</strong></li>
</ul>
<p><br></p>
<h2 id="2-查询：数字相关"><a href="#2-查询：数字相关" class="headerlink" title="2. 查询：数字相关"></a>2. 查询：数字相关</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>功能描述</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>ABS</td>
<td>返回表达式<strong>绝对值</strong></td>
<td>SELECT  ABS(-90)  返回：90</td>
</tr>
<tr>
<td>ROUND</td>
<td>按指定的精度进行<strong>四舍五入</strong></td>
<td>SELECT  ROUND(56.629, 2)  返回：56.630</td>
</tr>
<tr>
<td>SQRT</td>
<td>返回指定表达式的<strong>平方根</strong></td>
<td>SELECT  SQRT(9)  返回：3</td>
</tr>
<tr>
<td>FLOOR</td>
<td>返回小于或等于指定数值表达式的最大整数 $\le$</td>
<td>SELECT  FLOOR(23.9)  返回:  23</td>
</tr>
<tr>
<td>CEILING</td>
<td>返回大于或等于指定数值表达式的最小整数 $\ge$</td>
<td>SELECT  CEILING(23.9)  返回：24</td>
</tr>
<tr>
<td>POWER</td>
<td>次方；返回x的y次方</td>
<td>SELECT POWER(2,3) ; 返回8</td>
</tr>
<tr>
<td>EXP</td>
<td>指数；e的x次方</td>
<td>SELECT EXP(2)  返回e$^2$</td>
</tr>
<tr>
<td>LN /LOG(x,y)</td>
<td>对数；</td>
<td>SELECT LN(e) ；返回1</td>
</tr>
<tr>
<td>MOD</td>
<td>返回x除以y的余数</td>
<td>SELECT MOD(9,2); 返回1</td>
</tr>
<tr>
<td>%</td>
<td>返回x除以y的余数</td>
<td>SELECT 9%2</td>
</tr>
<tr>
<td>SIGN</td>
<td>判断正负；若x为正返回1；若x为负 返回-1 ; 若x为0 返回0</td>
<td>SELECT SIGN(2); 返回1</td>
</tr>
</tbody>
</table>
<h2 id="3-查询：聚合函数"><a href="#3-查询：聚合函数" class="headerlink" title="3. 查询：聚合函数"></a>3. 查询：聚合函数</h2><ul>
<li><strong>聚合是在对From和Where子句筛选后的数据集进行聚合计算；即运营逻辑是在其之后执行</strong></li>
<li>聚合函数，它的对象是<strong>多个</strong>观测值，但只<strong>返回一个值</strong>；若要出现多个观测值的聚合值，需要用到<strong>Group by 函数</strong></li>
<li><strong>一旦查询包含了聚合函数，那么每一列必须参与到聚合函数中。</strong><ul>
<li>SELECT语句中<strong>除聚合函数外</strong>，所有列应写在<strong>Group By语句后面</strong>。否则将出现错误</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>函数名</th>
<th>功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>AVG</td>
<td>平均值</td>
</tr>
<tr>
<td>SUM</td>
<td>求和</td>
</tr>
<tr>
<td>MAX/MIN</td>
<td>求最大值/最小值</td>
</tr>
<tr>
<td>COUNT</td>
<td>计算非空单元格（ 返回 int 数据类型值）</td>
</tr>
<tr>
<td>count_big</td>
<td>计算非空单元格（返回 bigint 数据类型值）</td>
</tr>
<tr>
<td>VAR</td>
<td>方差    # 平方</td>
</tr>
<tr>
<td>varp</td>
<td><em>总体方差</em></td>
</tr>
<tr>
<td>STDEV</td>
<td>标准差</td>
</tr>
<tr>
<td>stdevp</td>
<td><em>总体标准差</em></td>
</tr>
</tbody>
</table>
<blockquote>
<p>除Count(*)外，所有聚合函数均忽略空值NULL；</p>
<blockquote>
<p>avg( ) $\ge$  $sum( ) \over count(*)$</p>
</blockquote>
<p>Count(*)，计数时也将NULL计入；Count(Null) 返回0；所有与NULL的计算，都返NULL</p>
<p>其他所有聚合函数，包括Count(col_name)的形式，计算时均已排除了NULL</p>
<blockquote>
<p>表a，观测值10行，其中2个NULL；<br>Count(*)   # 返回10；</p>
<p>Count(列名)   # 返回8</p>
</blockquote>
<p>除非，可用 isnull() 函数进行转换，来计算；</p>
<blockquote>
<p>例如，对表a求平均值，若直接用avg() ，其分母为8；</p>
<p>若想使得其分母变成10，应添加 case when isnull(col_name,0) then col_name else end</p>
</blockquote>
</blockquote>
<h2 id="4-查询：日期相关"><a href="#4-查询：日期相关" class="headerlink" title="4. 查询：日期相关"></a>4. 查询：日期相关</h2><table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Getdate</td>
<td>返回<strong>当前服务器</strong>的日期和时间</td>
</tr>
<tr>
<td style="text-align:left">Current_timestamp</td>
<td>除了ANSI标准，等同于Getdate</td>
</tr>
<tr>
<td style="text-align:left">Getutcdate</td>
<td>返回当前服务器的日期和时间，并转化为<strong>格林威治标准时间</strong></td>
</tr>
<tr>
<td style="text-align:left">Sysdatetime</td>
<td>返回当前服务器的日期和时间</td>
</tr>
<tr>
<td style="text-align:left">Sysutcdatetime</td>
<td>返回当前服务器日期，并转化为格林威治标准时间</td>
</tr>
<tr>
<td style="text-align:left">Sysdatetimeoffset</td>
<td>返回Datetimeoffset值</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>日期处理函数</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Dateadd</td>
<td>在指定的日期上<strong>累加数值</strong>得到新的日期；dateadd(datepart,number,date)</td>
<td>SELECT  DATEADD(yyyy, 4, ‘01/09/2003’)  返回：2007-01-09</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td><em>datepar</em>是参数的格式：datepart=yy(年)，mm(月)，qq(季度)；<em>date</em> 参数是合法的日期表达式。<em>number</em> 是您希望添加的间隔数；对于未来的时间，此数是正数，对于过去的时间，此数是负数。</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">DATEDIFF</td>
<td>返回两个日期的<strong>差值</strong> ； datediff(datepart,startdate,endate)</td>
<td>SELECT  DATEDIFF(dd,  ‘02/05/2003’, ‘02/09/2005’)  返回：735</td>
</tr>
<tr>
<td style="text-align:left">DATEPART</td>
<td>返回指定日期<strong>部分</strong>的整数（整数形式）</td>
<td>SELECT DATEPART(dd,  ‘01/09/2003’)  返回：9</td>
</tr>
<tr>
<td style="text-align:left">DATENAME</td>
<td>返回指定日期部分的字符串（字符串形式）；工作日(dw)、周(wk)、日(dd)、月(mm)</td>
<td>SELECT  DATENAME(dw,  ‘02/02/2009’)  返回:  星期一</td>
</tr>
<tr>
<td style="text-align:left">Eomonth</td>
<td>返回针对指定开始日期的月份的最后一天</td>
<td>Select Eomonth(‘5/27/1998’)</td>
</tr>
<tr>
<td style="text-align:left">YEAR</td>
<td>返回指定日期“年”部分整数</td>
<td>SELECT  YEAR(GETDATE())  返回：当前年份整数</td>
</tr>
<tr>
<td style="text-align:left">MONTH</td>
<td>返回指定日期“月”部分整数</td>
<td>SELECT  MONTH(GETDATE())  返回：当前月份整数</td>
</tr>
<tr>
<td style="text-align:left">DAY</td>
<td>返回指定日期“日”部分整数</td>
<td>SELECT  DAY(GETDATE())  返回：当前日期整数</td>
</tr>
</tbody>
</table>
<h3 id="查询：日期的应用"><a href="#查询：日期的应用" class="headerlink" title="查询：日期的应用"></a>查询：日期的应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"># 获取当前时间 - getdate</div><div class="line">select getdate();</div><div class="line"></div><div class="line"></div><div class="line"># 返回指定的时间 - dateadd</div><div class="line">select dateadd(mm, -1, &apos;2017-03-31&apos;);  ----返回 2017-02-31</div><div class="line">	# datepart：yy/qq/mm/ww/dd/hh/mi/ss/ms ; </div><div class="line">	# num为正或为负；</div><div class="line">--dateadd()仅接受提取日期部分</div><div class="line"></div><div class="line"></div><div class="line"># 计算两个时间差 - datediff</div><div class="line">select datediff(dd,&apos;2016-06-01&apos;, &apos;2017-01-31&apos;); # yy/qq/mm/ww/dd/hh/mi/ss/ms</div><div class="line">--datediff(date_type,startdate , enddate)</div><div class="line"></div><div class="line"></div><div class="line"># 取出时间的某一部分 - datename/datepart --只能取出 年 或者 月 或者 日 </div><div class="line">select datename(dd, &apos;2017-01-31&apos;);  # datename 字符串形式</div><div class="line">select datepart(dd, &apos;2017-01-31&apos;);  # datepart 整数形式</div><div class="line">Select Convert(varchar(),,120)  ---- 可以取出前面的所有部分</div><div class="line">--返回上一个月 Select Convert(varchar(7), dateadd(mm,-1,getdate()),120)</div><div class="line"># 返回星期几 - detename</div><div class="line">Select datename(dw, &apos;2017-01-31&apos;)</div><div class="line"></div><div class="line"></div><div class="line"># 获取日期的年份/季度/月度/日期等 </div><div class="line">select year(getdate());  quarter/month/day</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"># 查看轴</div><div class="line">select datepart(week,getdate())</div><div class="line">-- 按周分组</div><div class="line">select datepart(week,convert(datetime,dateTimeCloumn,121)) &apos;周&apos;,count(distinct users) &apos;人数&apos;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"># 返回针对指定开始日期的月份的最后一天 - Eomonth</div><div class="line">Select Eomonth(&apos;2016-02-32&apos;,1)  # 返回 2016-03-31</div><div class="line">Select EOmonth(getdate(),-1)</div><div class="line">--Eomonth(start_date, month_to_add)</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h3><blockquote>
<p>时间戳就是一个从1970-01-01 08:00:00到时间的相隔的秒数</p>
</blockquote>
<ul>
<li><strong>dateadd(s, string, format)：时间戳转日期格式</strong></li>
<li><strong>datediff(s,format,time)：普通时间转时间戳</strong></li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-- 时间戳转日期格式</div><div class="line">SELECT DATEADD(S,<span class="number">1160701488</span>,<span class="string">'1970-01-01 08:00:00'</span>)  </div><div class="line"></div><div class="line">--普通时间转换成时间戳</div><div class="line">SELECT DATEDIFF(S,<span class="string">'1970-01-01 08:00:00'</span>, GETDATE())</div></pre></td></tr></table></figure>
<blockquote>
<p>注解：北京时间与GMT时间关系</p>
<p>1.GMT是中央时区,北京在东8区,相差8个小时 　　</p>
<p> 2.所以北京时间 = GMT时间 + 八小时</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; select DATEADD(second,<span class="number">1268738429</span> + <span class="number">8</span> * <span class="number">60</span> * <span class="number">60</span>,<span class="string">'1970-01-01 00:00:00'</span>)</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unix_timestamp(time) 这个转换成时间戳，from_unixtime(unix_timestamp(time)) 这个转换成datetime</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Datepart-设置周末为第一天"><a href="#Datepart-设置周末为第一天" class="headerlink" title="Datepart 设置周末为第一天"></a>Datepart 设置周末为第一天</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">-----2014-01-05为周日</div><div class="line"></div><div class="line">-- The default first date in a week is Sunday, the value is 7</div><div class="line">SELECT @@DATEFIRST  </div><div class="line"></div><div class="line">-- Default DATEFIRST is Sunday</div><div class="line">SELECT DATENAME(WEEK,&apos;2013-12-31&apos;) AS WeekName  -- 53</div><div class="line">SELECT DATENAME(WEEK,&apos;2014-01-01&apos;) AS WeekName  -- 1</div><div class="line">SELECT DATENAME(WEEK,&apos;2014-01-05&apos;) AS WeekName  -- 2</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">-- Change the DATEFIRST to 1, Monday will be the first day of week.</div><div class="line">SET DATEFIRST 1 </div><div class="line"></div><div class="line">SELECT @@DATEFIRST  -- 1</div><div class="line"></div><div class="line">-- After change the DATEFIRST to Monday</div><div class="line">SELECT DATENAME(WEEK,&apos;2013-12-31&apos;) AS WeekName  -- 53</div><div class="line">SELECT DATENAME(WEEK,&apos;2014-01-01&apos;) AS WeekName  -- 1</div><div class="line">SELECT DATENAME(WEEK,&apos;2014-01-05&apos;) AS WeekName  -- 1</div></pre></td></tr></table></figure>
<blockquote>
<p>要注意的是 SET DATEFIRST 只在<strong>当前执行中有效</strong>，也就说比如新开一个查询页面继续查询 SELECT @@DATEFIRST 则还是显示默认值 7。</p>
</blockquote>
<p><br></p>
<h3 id="参考：日期缩写参考"><a href="#参考：日期缩写参考" class="headerlink" title="参考：日期缩写参考"></a>参考：日期缩写参考</h3><ul>
<li>datediff / datename / datepart /dateadd</li>
</ul>
<table>
<thead>
<tr>
<th>日期部分</th>
<th>缩写</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>year</strong></td>
<td><strong>yy, yyyy</strong></td>
</tr>
<tr>
<td><strong>quarter</strong></td>
<td><strong>qq, q</strong></td>
</tr>
<tr>
<td><strong>month</strong></td>
<td><strong>mm, m</strong></td>
</tr>
<tr>
<td><strong>dayofyear</strong></td>
<td><strong>dy, y</strong>  #  查询date在当年是第多少天. 一年中的第几天；</td>
</tr>
<tr>
<td><strong>day</strong></td>
<td><strong>dd, d</strong></td>
</tr>
<tr>
<td><strong>week</strong></td>
<td><strong>wk, ww</strong>  # 查询date在当年中是第几周 / 以周为单位的间隔数</td>
</tr>
<tr>
<td><strong>weekday</strong></td>
<td><strong>dw  </strong># 一周中的第几天(星期几)</td>
</tr>
<tr>
<td><strong>Hour</strong></td>
<td><strong>hh</strong></td>
</tr>
<tr>
<td><strong>minute</strong></td>
<td><strong>mi, n</strong></td>
</tr>
<tr>
<td><strong>second</strong></td>
<td><strong>ss, s</strong></td>
</tr>
<tr>
<td><strong>millisecond</strong></td>
<td><strong>ms</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>convert - style的参考值</li>
<li>一位或两位数字样式提供两位数的年份；<strong>3位数字样式提供4位数字的年份；</strong></li>
</ul>
<table>
<thead>
<tr>
<th>代码</th>
<th>Style 格式</th>
</tr>
</thead>
<tbody>
<tr>
<td>100 或者 0</td>
<td>mon dd yyyy hh:miAM （或者 PM）</td>
</tr>
<tr>
<td>101</td>
<td>mm/dd/yy</td>
</tr>
<tr>
<td>102</td>
<td>yy.mm.dd</td>
</tr>
<tr>
<td>103</td>
<td>dd/mm/yy</td>
</tr>
<tr>
<td>104</td>
<td>dd.mm.yy</td>
</tr>
<tr>
<td>105</td>
<td>dd-mm-yy</td>
</tr>
<tr>
<td>106</td>
<td>dd mon yy</td>
</tr>
<tr>
<td>107</td>
<td>Mon dd, yy</td>
</tr>
<tr>
<td><strong>108</strong></td>
<td>hh:mm:ss</td>
</tr>
<tr>
<td>109 或者 9</td>
<td>mon dd yyyy hh:mi:ss:mmmAM（或者 PM）</td>
</tr>
<tr>
<td>110</td>
<td>mm-dd-yy</td>
</tr>
<tr>
<td><strong>111</strong></td>
<td><strong>yy/mm/dd</strong></td>
</tr>
<tr>
<td>112</td>
<td>yymmdd</td>
</tr>
<tr>
<td>113 或者 13</td>
<td>dd mon yyyy hh:mm:ss:mmm(24h)</td>
</tr>
<tr>
<td>114</td>
<td>hh:mi:ss:mmm(24h)</td>
</tr>
<tr>
<td><strong>120</strong> 或者 20</td>
<td>yyyy-mm-dd hh:mi:ss(24h)</td>
</tr>
<tr>
<td>121 或者 21</td>
<td>yyyy-mm-dd hh:mi:ss.mmm(24h)</td>
</tr>
<tr>
<td>126</td>
<td>yyyy-mm-ddThh:mm:ss.mmm（没有空格）</td>
</tr>
<tr>
<td>130</td>
<td>dd mon yyyy hh:mi:ss:mmmAM</td>
</tr>
</tbody>
</table>
<h2 id="5-查询：表格相关"><a href="#5-查询：表格相关" class="headerlink" title="5. 查询：表格相关"></a>5. 查询：表格相关</h2><h3 id="限定行数-TOP"><a href="#限定行数-TOP" class="headerlink" title="限定行数 - TOP"></a>限定行数 - TOP</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># TOP n( 前n行 )</div><div class="line">SELECT TOP 5 *  FROM  allzjb;  #　查询所有数据的中前5个</div><div class="line"></div><div class="line">------------------------</div><div class="line">TOP n PERCENT ( 按百分比取数据 )</div><div class="line">SELECT Top 30 PERCENT * FROM allzjb ;</div></pre></td></tr></table></figure>
<h4 id="With-Ties"><a href="#With-Ties" class="headerlink" title="With Ties"></a>With Ties</h4><ol>
<li>允许最后的位置包含多行，但这多行是完全相同的</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Select top (10) With Ties listprice From ...</div></pre></td></tr></table></figure>
<h4 id="随机行选择"><a href="#随机行选择" class="headerlink" title="随机行选择"></a>随机行选择</h4><ol>
<li>使用Top(1) 返回单行，且用Newid()随机排序结果；每次将返回一个随机值</li>
<li>涉及到较大的表时，可用Tablesample( n Percent/Rows)选项</li>
<li>由于是随机选择，可通过Repeatable()来指定 [效果同R语言中的set.seed()]</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Select top(1) Lastname From person.person Tablesample(10 Percent) -- 随机选择10%的</div><div class="line">  Repeatable(1234)</div><div class="line">  Order by Newid();  --随机排序结果集</div></pre></td></tr></table></figure>
<h3 id="分组-amp-排序"><a href="#分组-amp-排序" class="headerlink" title="分组&amp;排序"></a>分组&amp;排序</h3><h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><ul>
<li>Group by 会根据某一列的值将数据集自动分成子集。<ul>
<li>对<strong>分组集</strong>来说，汇总行是每个子集中的每个<strong>唯一值</strong>组成的行</li>
</ul>
</li>
<li>数据集被分成子组之后，聚合函数在每一个子组上执行。</li>
<li><strong>对于Group by子句，空值NULL被认为是相等的，并被分组到单个结果行</strong></li>
<li>Group by不局限于对列分组，也可以对<strong>表达式执行分组</strong>（但该表达式必须与Select中的相同）</li>
</ul>
<h4 id="分组后筛选"><a href="#分组后筛选" class="headerlink" title="分组后筛选"></a>分组后筛选</h4><p><strong>HAVING</strong></p>
<ul>
<li>what ：<strong>指定组或聚合的搜索条件</strong>；HAVING 通常在 GROUP BY 子句中使用，对Group by 之后的表单进行条件筛选；但针对的是所有group by 的字段，而非第一个</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Select 交易账号,建平仓,[交易间隔(s)] From #b11  where [交易间隔(s)] &lt; &apos;60&apos;</div><div class="line">  group by 交易账号,建平仓,[交易间隔(s)]</div><div class="line">  having count([交易间隔(s)]) &gt;= 2  </div><div class="line"> --指的是对满足所有group by字段的观测值进行计数统计；因为每个观测值都已经按照分组划分为不完全相同的观测值（每行中必定有一个不相等），所以结果为0</div></pre></td></tr></table></figure>
<ul>
<li>如果不使用 GROUP BY 子句，则 HAVING 的行为与 WHERE 子句一样。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">--HAVING 子句从 SalesOrderID 表中检索超过 SalesOrderDetail 的每个 $100000.00 的总计</div><div class="line">SELECT SalesOrderID, SUM(LineTotal) AS SubTotal  </div><div class="line">  FROM Sales.SalesOrderDetail  </div><div class="line">    GROUP BY SalesOrderID  </div><div class="line">    HAVING SUM(LineTotal) &gt; 100000.00  </div><div class="line">    ORDER BY SalesOrderID ;</div></pre></td></tr></table></figure>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><ul>
<li><strong>Select 指定的每一列都应该出现在Group By子句中，除非对这一列使用了聚合函数；</strong></li>
<li><strong>排序：Order by</strong><ul>
<li>可以使用<strong>表达式</strong>来指定顺序</li>
<li>可以使用<strong>列别名</strong>指定顺序</li>
<li>可以使用<strong>列的顺序位置</strong>来进行排序</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 按某个组分组并排序</div><div class="line">group by name</div><div class="line">order by name;</div><div class="line"></div><div class="line">----------------------</div><div class="line">GROUP BY name</div><div class="line">ORDER BY first_name, last_name DESC, SUM(age);  # 默认为升序排序（ASC）</div></pre></td></tr></table></figure>
<h2 id="窗口函数-Select-Over"><a href="#窗口函数-Select-Over" class="headerlink" title="窗口函数 - Select Over()"></a>窗口函数 - Select Over()</h2><h3 id="聚合子句"><a href="#聚合子句" class="headerlink" title="聚合子句"></a>聚合子句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Sum(cola) Over(partition by col1 order by col2)</div><div class="line">--其他聚合函数：avg/max/min /count </div><div class="line"></div><div class="line"># 根据分组求和</div><div class="line">Over(Partition by col1) --根据col1的分组对cola进行求和； [若同一组别有多个维度，则求和的值是相同的]</div><div class="line"></div><div class="line"># 根据排名求累计和</div><div class="line">Over(Order by col2)--根据col2的顺序对cola列累计求和； [若同一组有多个维度，求和的值是累加的]</div><div class="line"></div><div class="line"># 根据分组后的排名，求累积和</div><div class="line">Over(Partition by col1 order by col2) --根据Col1的分组进行排名得出Col2的次序，并按col2的次序对cola进行分组求和</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 移动平均</div><div class="line">CONVERT(varchar(20),AVG(SalesYTD) OVER (ORDER BY DATEPART(yy,ModifiedDate)),1) AS MovingAvg</div></pre></td></tr></table></figure>
<p><img src="![](http://chf2012.oss-cn-hangzhou.aliyuncs.com/daily_pic/S软件应用_SQL01.jpg" alt="窗口函数"></p>
<blockquote>
<p>在窗口内<strong>分区：Partition by</strong></p>
<ul>
<li>执行逻辑：先对查询结果进行排序，之后通过Partition by的列进行分区；</li>
<li>窗口函数只能在Select 或者 Group by 子句中</li>
</ul>
</blockquote>
<h3 id="排名-rank子句"><a href="#排名-rank子句" class="headerlink" title="排名 - rank子句"></a>排名 - rank子句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># 排名：无重复排名 - Row_number（组内连续的唯一的)</div><div class="line">row_number() over (order by col2);  # 对所有进行排名</div><div class="line">row_number() over (partition by col1 order by col2);  # 根据COL1分组，在分组内部根据 COL2排序</div><div class="line"></div><div class="line"></div><div class="line">-------------------------------------------------</div><div class="line">#　排名：有重复排名 - Rank （若出现字段值相同，序号一样，下一个跳过1位[排名是非连续的]）</div><div class="line">rank() over([partion by col1] order by col2); 对所有进行排名</div><div class="line"></div><div class="line">ProductID   Name                   LocationID   Quantity Rank  </div><div class="line">494         Paint - Silver         3            49       1  </div><div class="line">495         Paint - Blue           3            49       1  </div><div class="line">493         Paint - Red            3            41       3 </div><div class="line"></div><div class="line"></div><div class="line">-------------------------------------------------</div><div class="line"># 排名：有重复排名 - Dense_rank （若出现字段值相同，序号一样，后一个不跳过[排名是连续的]）</div><div class="line">dense_rank() over([partion by col1] order by col2)</div><div class="line"></div><div class="line">ProductID   Name                               LocationID Quantity Rank  </div><div class="line">494         Paint - Silver                     3          49       1  </div><div class="line">495         Paint - Blue                       3          49       1  </div><div class="line">493         Paint - Red                        3          41       2 </div><div class="line"></div><div class="line"></div><div class="line">-------------------------------------------------</div><div class="line"># 排名：对序号进行分组处理 - Ntile</div><div class="line">ntile (4) over ([partion by col1] order by col2);  # (4)表示分为4组</div></pre></td></tr></table></figure>
<blockquote>
<p>ntile函数的分组依据（约定）：</p>
<p>　　首先系统会去检查能不能对所有满足条件的记录进行平均分组，若能则直接平均分配就完成分组了；若不能，则会先分出一个组，这个组分多少条记录呢？就是 （总记录数/总组数）+1 条，之所以分配 （总记录数/总组数）+1 条是因为当不能进行平均分组时，总记录数%总组数肯定是有余的，又因为分组约定1，所以先分出去的组需要+1条。</p>
<p>　　分完之后系统会继续去比较余下的记录数和未分配的组数能不能进行平均分配，若能，则平均分配余下的记录；若不能，则再分出去一组，这个组的记录数也是（总记录数/总组数）+1条。</p>
<p><strong>举个例子，将53条记录分配成5组，53%5 = 3不能平均分配，则将余数3平均分配到前3组 （余数 = 分配的组数），然后比较余下的 53-(11*3)=20 条记录能否平均分配给未分配的2组，能平均分配，则剩下的2组，每组各20/2=10 条记录，分配完成，分配结果为：11，11，11，10，10。</strong></p>
</blockquote>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Offset &amp; Fetch 必须结合使用</div><div class="line">Select ... From</div><div class="line">  Order by </div><div class="line">  Offset n rows  # 表示跳过n行</div><div class="line">  Fetch Next 20 rows only  # 表示返回之后的20行</div></pre></td></tr></table></figure>
<h2 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h2><ul>
<li><p><strong>case when</strong></p>
<ul>
<li><p>最大的优点是可以与Select语句“内联”</p>
</li>
<li><p>若else缺失，表示其他值返回NULL</p>
</li>
<li><p><strong>Case函数只返回第一个符合条件的值，剩下的Case部分将会被自动忽略；</strong></p>
<ul>
<li><strong>所以，如果根据金额大小来判定等级，必须要最高的金额写在最前面；</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> ## 两者区别</div><div class="line">1. 输入表达式，只能用于等同性(=)检查</div><div class="line">2. 布尔表达式，不局限于等同行(=)检查</div><div class="line"></div><div class="line">--用输入表达式，将与每个where子句中的值比较</div><div class="line">Case &lt;input expression&gt;  --只能用于等同性检查，而不进行其他比较</div><div class="line">   when &lt;when exp&gt; then &lt;result exp&gt;</div><div class="line">   [n...]</div><div class="line">   [else &lt;result exp&gt;]</div><div class="line">End</div><div class="line"></div><div class="line">--给每个when子句提供一个布尔表达式，求值为TRUE或FALSE [布尔值是“真” True 或“假” False 中的一个]</div><div class="line"> Case</div><div class="line">   when &lt;Boolean exp&gt; then &lt;result exp&gt;</div><div class="line">   [n...]</div><div class="line">   [else &lt;result exp&gt;]</div><div class="line">End</div></pre></td></tr></table></figure>
<p>–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">## 1.简单Case语句</div><div class="line"></div><div class="line"># 在SELECT语句中，CASE 简单表达式只能用于等同性检查，而不进行其他比较</div><div class="line">SELECT ProductNumber, Category =  </div><div class="line">      CASE ProductLine     --表示如果 ProductLine = R 则返回 Road； Case之后的变量，为比较的变量</div><div class="line">         WHEN &apos;R&apos; THEN &apos;Road&apos;  </div><div class="line">         WHEN &apos;M&apos; THEN &apos;Mountain&apos;  </div><div class="line">         WHEN &apos;T&apos; THEN &apos;Touring&apos;  </div><div class="line">         WHEN &apos;S&apos; THEN &apos;Other sale items&apos;  </div><div class="line">         ELSE &apos;Not for sale&apos;  </div><div class="line">      END,  </div><div class="line">   Name  </div><div class="line">  FROM Production.Product ； </div><div class="line"></div><div class="line">--</div><div class="line">Select top 10 SalesOrderID % 10 As &apos;OrderLastDigit&apos;,ProductID % 10 As &apos;ProductLastDigit&apos;,</div><div class="line">&quot;How Colse ?&quot; =  CASE SalesOrderID % 10 </div><div class="line">         WHEN  ProductID % 1  THEN &apos;Exact Match&apos;   -- 可在When子句中引用第二个列来做判断</div><div class="line">         WHEN  ProductID % 1-1 THEN &apos;Within 1&apos;  </div><div class="line">         WHEN  ProductID % 1+1 THEN &apos;Within 1&apos;  </div><div class="line">         ELSE &apos;More Than One Apart&apos;  </div><div class="line">      END  </div><div class="line">FROM Sales.SalesOrderDetail ；</div><div class="line">-- % 表示返回余数； 5%2 返回1</div><div class="line">-- 变量名在Case之前使用双引号（“”）说明，该变量是新创建的变量;但不建议如此；</div><div class="line"></div><div class="line">------------------------------------------------------</div><div class="line">## 2. 搜索Case语句</div><div class="line">-- 没有输入表达式（即Case关键字与第一个When之间的部分）</div><div class="line">-- When表达式必须求值为一个 布尔值；（Case简单语句中，When的表达式可以为1、3、Price+1[含运算]）</div><div class="line"></div><div class="line">Select top 10 SalesOrderID % 10 As &apos;OrderLastDigit&apos;,ProductID % 10 As &apos;ProductLastDigit&apos;,</div><div class="line">&quot;How Colse ?&quot; =  CASE   					  -- 没有输入表达式</div><div class="line">   WHEN (SalesOrderID % 10) &lt; 3 THEN &apos;Ends With Less Than Threes&apos; </div><div class="line">   WHEN ProductID =6 THEN &apos;ProductID is 6&apos;     -- 可在When子句中引用第二个列来做判断</div><div class="line">   WHEN ABS(SalesOrderID % 10 - ProductID) &lt;= 1 THEN &apos;Within 1&apos;  </div><div class="line">   ELSE &apos;More Than One Apart&apos;  </div><div class="line">      END  </div><div class="line">FROM Sales.SalesOrderDetail ；</div><div class="line"></div><div class="line"># Case函数只返回第一个符合条件的值，剩下的Case部分将会被自动忽略</div><div class="line"># 可在条件表达式中混合搭配的字段</div><div class="line"># 可执行为任何表达式，只要最后的结果为布尔值</div></pre></td></tr></table></figure>
<ul>
<li><strong>搭配其他函数用法</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"># SELECT CASE WHEN 用法</div><div class="line">select userID ,  </div><div class="line">count(CASE WHEN letterType=&apos;干部介绍信&apos; then &apos;1&apos; end)干部介绍信数,  </div><div class="line">count(CASE WHEN letterType=&apos;转递档案通知单&apos; then &apos;1&apos; end)转递档案通知单数  </div><div class="line">from T_LettersRecord GROUP BY userID  </div><div class="line"></div><div class="line">------------------------------------------------------</div><div class="line"># WHERE CASE WHEN 用法</div><div class="line">SELECT l.letterType, u.realName  </div><div class="line">   FROM T_LettersRecord as l, T_User as u  </div><div class="line">  WHERE (CASE </div><div class="line">           WHEN l.letterType = &apos;干部介绍信&apos; AND u.userID = &apos;1&apos;  THEN 1  </div><div class="line">           WHENl.letterType = &apos;干部介绍信&apos; AND  u.userID &lt;&gt; &apos;1&apos;  THEN 1  </div><div class="line">         ELSE 0   </div><div class="line">         END) = 1  </div><div class="line"></div><div class="line">------------------------------------------------------</div><div class="line"># 在 ORDER BY 子句中使用 CASE </div><div class="line">--计算 SalariedFlag 表中 HumanResources.Employee 列的值。SalariedFlag 设置为 1 的员工将按 BusinessEntityID 以降序顺序返回。 SalariedFlag 设置为 0 的员工将按 BusinessEntityID 以升序顺序返回</div><div class="line">SELECT BusinessEntityID, SalariedFlag  </div><div class="line">  FROM HumanResources.Employee  </div><div class="line">  ORDER BY CASE SalariedFlag WHEN 1 THEN BusinessEntityID END DESC  </div><div class="line">        ,CASE WHEN SalariedFlag = 0 THEN BusinessEntityID END;</div><div class="line"></div><div class="line">------------------------------------------------------</div><div class="line"># GROUP BY CASE WHEN 用法</div><div class="line">SELECT   </div><div class="line">CASE WHEN salary &lt;= 3000 THEN &apos;T1&apos;   </div><div class="line">WHEN salary &gt; 3000 AND salary &lt;=8000  THEN&apos;T2&apos;   </div><div class="line">WHEN salary &gt; 8000 AND salary &lt;=12000  THEN&apos;T3&apos;   </div><div class="line">WHEN salary &gt; 12000 AND salary &lt;= 20000 THEN &apos;T4&apos;   </div><div class="line">ELSE NULL END 级别名称, -- 别名命名  </div><div class="line">COUNT(*)   </div><div class="line">FROM    t_userSalary  </div><div class="line">GROUP BY   </div><div class="line">CASE WHEN salary &lt;= 3000 THEN &apos;T1&apos;   </div><div class="line">WHEN salary &gt; 3000 AND salary &lt;=8000  THEN&apos;T2&apos;   </div><div class="line">WHEN salary &gt; 8000 AND salary &lt;=12000  THEN&apos;T3&apos;   </div><div class="line">WHEN salary &gt; 12000 AND salary &lt;= 20000 THEN &apos;T4&apos;   </div><div class="line">ELSE NULL END;</div></pre></td></tr></table></figure>
<h2 id="联接与联合"><a href="#联接与联合" class="headerlink" title="联接与联合"></a>联接与联合</h2><ul>
<li><p>what：将两个数据集相乘，并对结果进行限制。这样只返回两个数据集的交集。</p>
</li>
<li><p>why  ：横向合并两个数据集，并通过匹配一个数据源的行与另一个数据源的行，从组合中产生新的数据集。</p>
<p>​</p>
</li>
</ul>
<p><br></p>
<h3 id="内联接"><a href="#内联接" class="headerlink" title="内联接"></a>内联接</h3><p><strong>Inner Join</strong></p>
<ul>
<li><p>在连接条件中使用等于号（=）运算符，其查询结果中列出被连接表中的所有列，<strong>包括其中的重复列</strong>。</p>
</li>
<li><p>在连接条件中使用除等于号之外运算符（&gt;、&lt;、&lt;&gt;、&gt;=、&lt;=、!&gt;和!&lt;）</p>
</li>
<li><p>多个数据源的联接（顺序并不重要）</p>
<ul>
<li>所要获得字段的表要写在最前面；即From之后；</li>
<li>可实现A联接B，B联接C，C联接D；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Select cst.companyname, prod.name </div><div class="line">  From Customre As a</div><div class="line">	Inner join salesorderhead As b On a.customerid = b.customerid</div><div class="line">	Inner join salesorderdetail As c On b.salesorderid = c.salesorderid</div><div class="line">	Inner join product As d On c.productid = d.productid</div></pre></td></tr></table></figure>
<blockquote>
<p>SQL内在处理逻辑：(按照排列顺序进行联接)</p>
<ol>
<li>先扫描a</li>
<li>Inner Join 表a 和 表b</li>
<li>然后将 a和b 联合表单 与表c Inner Join</li>
<li>最后将上面联合表 与 表d Inner Join</li>
</ol>
</blockquote>
<p>​</p>
</li>
</ul>
<h3 id="外联接"><a href="#外联接" class="headerlink" title="外联接"></a>外联接</h3><blockquote>
<p>可<strong>多条件连接</strong>；即在原来连接的基础上再进行连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt;   From #a2 As a</div><div class="line">&gt;   Left Join [exchange].[GFFCC_YTX].[v_qhkh] As b</div><div class="line">&gt;     On a.手机 = b.手机</div><div class="line">&gt;   Left Join [ADHOC_YTX].[zhangcm].[期货客户属性表] As c</div><div class="line">&gt;     On b.资金号 = c.投资者代码</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p>what：以一个表为基准表，进行联接；</p>
<ul>
<li>若使用外联接，<strong>顺序非常重要</strong></li>
<li><strong>慎用</strong> 不等连接 <code>on a.id &lt;&gt; b.id</code> ，因为会对每一条记录a无法匹配的b表中的行生成一条记录，最后会生成 $a \times b$  行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">select * form tab1 left join tab2 on (tab1.size != tab2.size)</div><div class="line">tab1.id	tab1.size	tab2.size	tab2.name</div><div class="line">1		10			20			BBB</div><div class="line">2		10			20			CCC</div><div class="line">2		10			(null)		(null)</div><div class="line">3		20			10           AAAA</div><div class="line">......</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>how  ：无论是否匹配，外联接都包含所有数据</p>
</li>
<li><p>How ：数据库在通过连接两张或多张表来返回记录时，都会生成一张<strong>中间的临时表，然后再将这张临时表返回给用户</strong>。</p>
<ul>
<li><p><strong>中间表</strong>是 左表与右表的<strong>所有字段</strong></p>
</li>
<li><p>on 与 where 的区别</p>
<ul>
<li><strong>on条件是在生成临时表时使用的条件，它不管on中的条件是否为真，都会返回左边表中的记录</strong></li>
</ul>
<blockquote>
<p><code>select * form tab1 left join tab2 on (tab1.size = tab2.size and tab2.name=’AAA’)</code> </p>
<p> 表示<strong>同时满足</strong>这两个条件<strong>才能匹配</strong>到记录<strong>（必须用括号<code>()</code>括起来）</strong> ，但条件不为真也会返回左表中的记录；</p>
<ul>
<li>可通过where子句限定 b.x Is Not Null 来返回该条记录 或 where tb2.name=’AAA’</li>
</ul>
</blockquote>
<ul>
<li><strong>where条件是在临时表生成好后，再对临时表进行过滤的条件。条件不为真的就全部过滤掉。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>关于 “A LEFT JOIN B ON 条件表达式” 的一点提醒</strong></p>
<p><strong>ON </strong>条件（<strong>“A LEFT JOIN B ON 条件表达式”</strong>中的<strong>ON</strong>）用来决定如何从 <strong>B</strong> 表中检索数据行。</p>
<p>如果 <strong>B</strong> 表中没有任何一行数据匹配 <strong>ON</strong> 的条件,将会额外生成一行所有列为 <strong>NULL</strong> 的数据</p>
<p>在匹配阶段 <strong>WHERE</strong> 子句的条件都不会被使用。仅在匹配阶段完成以后，<strong>WHERE</strong> 子句条件才会被使用。它将从匹配阶段产生的数据中检索过滤。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">select * form tab1 left join tab2 on (tab1.size = tab2.size) where tab2.name=’AAA’</div><div class="line">/*</div><div class="line">1.中间表：on条件:  tab1.size = tab2.size	</div><div class="line"></div><div class="line">tab1.id	tab1.size	tab2.size	tab2.name</div><div class="line">1		10			10			AAA</div><div class="line">2		20			20			BBB</div><div class="line">2		20			20			CCC</div><div class="line">3		30			(null)		(null)</div><div class="line"> </div><div class="line">2.再对中间表过滤：where 条件：tab2.name=’AAA’	</div><div class="line"></div><div class="line">tab1.id	tab1.size	tab2.size	tab2.name</div><div class="line">1		10			10			AAA</div><div class="line">*/</div><div class="line"></div><div class="line">select * form tab1 left join tab2 on (tab1.size = tab2.size and tab2.name=’AAA’)  --表示同时满足这两个条件才能匹配到记录(条件不为真也会返回左表中的记录)	</div><div class="line">/*</div><div class="line">1. 中间表 ： on条件: tab1.size = tab2.size and tab2.name=’AAA’</div><div class="line"></div><div class="line">tab1.id	tab1.size	tab2.size	tab2.name</div><div class="line">1		10			10			AAA         ----仅同时满足的进行匹配，但仍然会返回所有的观测行；</div><div class="line">2		20			(null)		(null)</div><div class="line">3		30			(null)		(null)</div><div class="line"> */</div></pre></td></tr></table></figure>
<blockquote>
<p>其实以上结果的关键原因就是<strong>left join,right join,full join</strong>的特殊性，不管on上的条件是否为真都会返回left或right表中的记录，full则具有left和right的特性的并集。 而inner jion没这个特殊性，则条件放在on中和where中，返回的结果集是相同的。</p>
<p>当涉及多个联接时</p>
<blockquote>
<p>一定要用较小规模的数据对查询进行单元测试；</p>
<p>并坚持使用左外联接</p>
</blockquote>
</blockquote>
<ul>
<li><p>外联接中的条件设置（执行逻辑）</p>
<ul>
<li><strong>当条件位于Join子句中，先包括外表的所有行，然后用条件包括第二个表中的行</strong></li>
<li><strong>当条件位于Where子句中，先执行联接，然后将条件应用于联接行</strong></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> # 条件位于Join子句</div><div class="line">  Select a.col, b.col </div><div class="line">    From table As a</div><div class="line">    Left join table2 As b </div><div class="line">  	On a.id = b.id </div><div class="line">  	And a.Lastname = &apos;Adams&apos;  --该条件限制的是第二个表中的行</div><div class="line">  	[And a.Lastname = b.name]  --也可以再进行限制</div><div class="line"></div><div class="line">------------------------------------------</div><div class="line"># 条件位于Where子句中</div><div class="line">Select a.col, b.col </div><div class="line">  From table As a</div><div class="line">  	Left join table2 As b </div><div class="line">  	   On a.id = b.id </div><div class="line">  Where a.Lastname = &apos;Adams&apos;   --该where条件是对联接后的表进行限制</div></pre></td></tr></table></figure>
<p> <br></p>
<p><strong>Left [Outer] Join</strong></p>
<ul>
<li>返回左表中的所有行，如果左表中行在右表中没有匹配行，则结果中右表中的列<strong>返回空值</strong>。</li>
</ul>
<blockquote>
<p>必须要表基准表放在左侧，非常重要！否则会产生大量NULL值。</p>
</blockquote>
<p><strong>Right [Outer] Join</strong></p>
<ul>
<li>恰与左连接相反，返回右表中的所有行，如果右表中行在左表中没有匹配行，则结果中左表中的列<strong>返回空值</strong>。</li>
</ul>
<blockquote>
<p>建议左/右外联接不要混合使用</p>
</blockquote>
<p><strong>Full [Outer] Join</strong></p>
<ul>
<li>返回<strong>左表和右表中的所有行</strong>。即返回两个数据集的所有数据。当某行在另一表中没有匹配行，则另一表中的列返回空值</li>
</ul>
<h3 id="交叉联接"><a href="#交叉联接" class="headerlink" title="交叉联接"></a>交叉联接</h3><p><strong>Cross Join</strong></p>
<ul>
<li>不带WHERE条件子句，它将会返回被连接的<strong>两个表的笛卡尔积</strong>，返回结果的<strong>行数等于两个表行数的乘积</strong><ul>
<li>（例如：T_student和T_class，返回4*4=16条记录）</li>
<li><strong>如果带where，返回或显示的是匹配的行数。</strong></li>
</ul>
</li>
</ul>
<h3 id="差集查询"><a href="#差集查询" class="headerlink" title="差集查询"></a>差集查询</h3><ul>
<li><strong>Left Join / Null</strong><ul>
<li>what：分析两个数据集之间相关性的查询；</li>
<li>why  ：用于查找不存在或不匹配的数据</li>
<li>how  ：一般需分两步来执行<ul>
<li>联接</li>
<li><strong>设置第二个数据集的主键为NULL</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>涉及where子句，<strong>or的条件子句</strong>一定要用括号<code>()</code>括起来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">-- 左差集查询</div><div class="line">--不在右表中的左表数据集；【可用Inner Join 中不等号为条件进行联接 &lt;&gt;】</div><div class="line"></div><div class="line">Select c.customerid, so.ordernumber </div><div class="line">  From customer As a</div><div class="line">  	Left join salesorder As b On a.customerid = b.customerid</div><div class="line">  Where b.ordernumer Is Null;  --设置第二个表的主键为NULL</div><div class="line"></div><div class="line">-- 返回在右表中的左表的值</div><div class="line">where  so.ordernumer Is Not Null;  --设置第二个表的主键为不为NULL，即与之</div><div class="line"></div><div class="line"># 全差集查询</div><div class="line">Select c.customerid, so.ordernumber </div><div class="line">  From customer As c</div><div class="line"> 	Left join salesorder As so On c.customerid = so.customerid</div><div class="line">  Where so.customerid Is Null </div><div class="line">	or c.customerid Is Null  </div><div class="line">--设置两个表的的主键为NULL</div></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Not In Like ( )</strong> ：小范围使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SELECT name FROM my_contacts</div><div class="line">  WHERE name [NOT] IN LIKE (&quot;A%&quot;,&quot;B%&quot;,&quot;C%&quot;)</div><div class="line"></div><div class="line">----联合</div><div class="line">SELECT name FROM my_contacts</div><div class="line">  WHERE name NOT IN (Select name From B)</div><div class="line"></div><div class="line">----子查询  查询选修了c02号课程的学生的姓名和所在系，学生表(student)，课程表(sc)</div><div class="line">SELECT Sname, Sdept FROM student</div><div class="line">  WHERE Sno IN (SELECT Sno FROM sc WHERE Cno = &apos;C02&apos;);  # 可在IN之前加NOT；即 WHERE sno NOT IN ...</div></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Exists &amp; Not Exists</strong> ：两个表之间；<ul>
<li>Exists ：返回仅在左表中的数据</li>
<li>Not Exists ：外层查询结果不存在于关联表里的方法（<strong>返回左边不在右表里面的观测值</strong>）</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意 Where 之后<strong>没有限定列名</strong>, <strong>条件限定在 子查询中</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">---- 常用于外层查询结果不存在于关联表里的方法</div><div class="line">--注意 Where 之后没有限定列名,条件限定在 子查询中</div><div class="line">SELECT TNAME,DEPART FROM teacher   </div><div class="line">  WHERE NOT EXISTS (SELECT * FROM course WHERE teacher.TNO = course.TNO);</div></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>EXCEPT</strong>： 返回在坐标中存在，但不在右表中的行；<ul>
<li>从左查询中返回右查询没有找到的所有非重复值。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SELECT ProductID </div><div class="line">	FROM Production.Product</div><div class="line">EXCEPT</div><div class="line">SELECT ProductID </div><div class="line">	FROM Production.WorkOrder ;</div></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="联合-Union"><a href="#联合-Union" class="headerlink" title="联合 - Union"></a>联合 - Union</h3><ol>
<li>返回每个结果集中的所有行<ul>
<li><strong>Union ，表示删除重复行</strong></li>
<li>Union ALL ，表示<strong>不考虑是否存在重复行</strong></li>
</ul>
</li>
<li>每个Select必须具有<strong>相同的数量、类型</strong>；</li>
<li><strong>列名或别名</strong>由第一个Select确定</li>
<li><strong>Order by子句放在最后</strong>，并且对所有结果进行排序，且列名必须是第一个Select语句中存在的</li>
<li>可用Select Into，但<strong>Into必须放在第一个Select语句中</strong></li>
</ol>
<blockquote>
<p>列的xml数据类型必须为等效。 </p>
<blockquote>
<p>所有的列必须类型化为 XML 架构或是非类型化的。 如果要类型化，这些列必须类型化为相同的 XML 架构集合。</p>
</blockquote>
</blockquote>
<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><h3 id="非相关子查询"><a href="#非相关子查询" class="headerlink" title="非相关子查询"></a>非相关子查询</h3><ul>
<li><p>what：子查询是独立运作的；</p>
</li>
<li><p>how  ：运行逻辑</p>
<ol>
<li><strong>非相关子查询被执行一次</strong></li>
<li><strong>结果传输到外查询</strong></li>
<li><strong>外查询被执行一次</strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Select (Select 3) As subqueryvalue;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h3 id="公用表表达式-CTE"><a href="#公用表表达式-CTE" class="headerlink" title="公用表表达式- CTE"></a>公用表表达式- CTE</h3><ul>
<li>what：CTE (Comman Table Expression )</li>
<li>why  ：确定查询结果可当做临时视图来使用；即后续的查询可以引用公共表表达式中的表及字段；</li>
<li>how  ：CTE使用With子句，而With子句定义了CTE；在With子句内分别是名称、别名、AS、括号、Select查询语句<ul>
<li>CTE自身只是<strong>一个不完整的SQL语句</strong></li>
<li>一旦With子句中定义了CTE，<strong>查询的主要部分就可以使用其名称引用CTE</strong>；就像CTE是其他任何表源一样；</li>
<li>若将<strong>多个CTE包含</strong>在相同的查询中，在主查询之前确定CTE的顺序，并用<strong>逗号分隔</strong><code>,</code>；并且后面的CTE可以引用在它之前定义的任何CTE</li>
<li>CTE不能嵌套</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># With子句的表达式格式</div><div class="line">With CTEname [Col Aliases]</div><div class="line">  As (Select ...From ...</div><div class="line">  )</div><div class="line">, CTEname2 [Col] As (Select)  ----多表共同表达式</div><div class="line">Select ...From ...</div><div class="line">------------------------------------------------------</div><div class="line">With </div><div class="line">  CTEname1 (col names) As (Select) ,  ----用逗号分隔</div><div class="line">  Ctename2 (col names) As (Select)</div><div class="line">Select ...</div><div class="line">  From CTEname1</div><div class="line">	Inner join CTEname2 On</div></pre></td></tr></table></figure>
<h3 id="相关子查询"><a href="#相关子查询" class="headerlink" title="相关子查询"></a>相关子查询</h3><ul>
<li>what：先执行外查询，相关子查询的运行要引用外查询中的列</li>
<li>why  ：对于复杂的Where条件来说很有用</li>
<li>how  ：执行逻辑<ol>
<li><strong>先执行一次外查询</strong></li>
<li><strong>在外查询中对每一行执行一次子查询，把外查询中的值取代为子查询的每一次执行</strong></li>
<li>子查询的结果要整合到结果集中</li>
</ol>
</li>
</ul>
<blockquote>
<p>子查询可出现在Select子句中，也可以出现在Where 子句中；</p>
<p>判断是否为相关子查询的标准为是否引用了外查询中的列；</p>
<blockquote>
<p>没有引用外查询中的列，为非相关子查询；先于外查询运行</p>
<p>引用了外查询中的列，为相关子查询，后于外查询运行</p>
</blockquote>
</blockquote>
<p><br></p>
<h2 id="数据透视-Pivot"><a href="#数据透视-Pivot" class="headerlink" title="数据透视 - Pivot"></a>数据透视 - Pivot</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">--------------------</div><div class="line">SELECT &lt;非透视的列&gt;,   ---------第一个Select 表示从 From 中的数据中返回的值</div><div class="line">    [第一个透视的列] AS &lt;列名称&gt;,</div><div class="line">    [第二个透视的列] AS &lt;列名称&gt;,</div><div class="line">    ...</div><div class="line">    [最后一个透视的列] AS &lt;列名称&gt;,</div><div class="line">FROM </div><div class="line">    (&lt;生成数据的 SELECT 查询&gt;)   ---------第二个Select 表示从 Pivot所要用到的数据</div><div class="line">    AS &lt;源查询的别名&gt;   -----As 的别名不可以省略</div><div class="line">PIVOT</div><div class="line">(</div><div class="line">    &lt;聚合函数&gt;(&lt;要聚合的列&gt;)   -----要计算的列</div><div class="line">FOR</div><div class="line">[&lt;包含要成为列标题的值的列&gt;]   ---------观测行所在的列名</div><div class="line">    IN ( [第一个透视的列], [第二个透视的列],   --------------上列中观测行的名称；可以理解为分类</div><div class="line">    ... [最后一个透视的列])</div><div class="line">) AS &lt;透视表的别名&gt;   -----As 的别名不可以省略</div><div class="line">&lt;可选的 ORDER BY 子句&gt;;</div></pre></td></tr></table></figure>
<ul>
<li><strong>示例1</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">--------原始数据</div><div class="line">结算日期 多空罗盘	期初权益			盈亏	佣金			损佣比		佣金转化率</div><div class="line">2017-08-25	0	32889.532389	-99.282000	120.902355	-0.821175	0.003676</div><div class="line">2017-07-28	1	12964.049298	-80.327000	45.525612	-1.764435	0.003511</div><div class="line">2017-09-01	1	24381.504055	-109.686000	70.774820	-1.549788	0.002902</div><div class="line">2017-08-01	0	36143.075381	-410.239000	55.022701	-7.455813	0.001522</div><div class="line">2017-08-30	0	33944.379618	-35.971500	94.818393	-0.379372	0.002793</div><div class="line">2017-07-19	1	9448.754481		22.619500	25.076349	0.902025	0.002653</div><div class="line">2017-08-29	0	33323.606632	-55.551000	129.617184	-0.428577	0.003889</div><div class="line">2017-08-21	1	17932.778420	-234.807000	83.943086	-2.797216	0.004680</div><div class="line"></div><div class="line"></div><div class="line">--------Pivot转换</div><div class="line">Select 结算日期 </div><div class="line">        , [1] As 期初权益_开通产品</div><div class="line">        , [0] As 期初权益_未开通</div><div class="line">    From (Select 结算日期,多空罗盘,期初权益</div><div class="line">            From [ADHOC_YTX].[caihf].[多空罗盘_交易数据]) As a </div><div class="line">        Pivot (Max(期初权益) For 多空罗盘 In([1],[0]))  As b</div><div class="line"></div><div class="line"></div><div class="line">------------多个列合并</div><div class="line">Select b1.*, b2.*</div><div class="line">    From (Select 结算日期,多空罗盘,期初权益</div><div class="line">            From [ADHOC_YTX].[caihf].[多空罗盘_交易数据]) As a1 </div><div class="line">        Pivot (Max(期初权益) For 多空罗盘 In([1],[0]))  As b1, ----------用逗号分隔符即可</div><div class="line">	(Select 结算日期,多空罗盘,期初权益</div><div class="line">            From [ADHOC_YTX].[caihf].[多空罗盘_交易数据]) As a2 </div><div class="line">        Pivot (Max(期初权益) For 多空罗盘 In([1],[0]))  As b2)</div></pre></td></tr></table></figure>
<ul>
<li><strong>示例2</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">----------未加工的数据</div><div class="line">SELECT DaysToManufacture, AVG(StandardCost) AS AverageCost </div><div class="line">FROM Production.Product</div><div class="line">GROUP BY DaysToManufacture;</div><div class="line"></div><div class="line">DaysToManufacture          AverageCost</div><div class="line">0                          5.0885</div><div class="line">1                          223.88</div><div class="line">2                          359.1082</div><div class="line">4                          949.4105</div><div class="line"></div><div class="line">----------Pivot转化后的数据</div><div class="line">-- Pivot table with one row and five columns</div><div class="line">SELECT &apos;AverageCost&apos; AS Cost_Sorted_By_Production_Days, </div><div class="line">[0], [1], [2], [3], [4]</div><div class="line">FROM</div><div class="line">(SELECT DaysToManufacture, StandardCost </div><div class="line">    FROM Production.Product) AS SourceTable</div><div class="line">PIVOT</div><div class="line">(</div><div class="line">AVG(StandardCost)</div><div class="line">FOR DaysToManufacture IN ([0], [1], [2], [3], [4])</div><div class="line">) AS PivotTable;</div><div class="line"></div><div class="line">Cost_Sorted_By_Production_Days    0         1         2           3       4       </div><div class="line">AverageCost                       5.0885    223.88    359.1082    NULL    949.4105</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="unpivot"><a href="#unpivot" class="headerlink" title="unpivot"></a>unpivot</h3><blockquote>
<p>UNPIVOT 并不完全是 PIVOT 的逆操作。PIVOT 会执行一次聚合，从而将多个可能的行合并为输出中的单个行。而 UNPIVOT 不会重现原始表值表达式的结果，因为行已经被合并了。另外，UNPIVOT 的输入中的空值不会显示在输出中，而在执行 PIVOT 操作之前，输入中可能有原始的空值。</p>
</blockquote>
<p><br></p>
<h2 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h2><h3 id="去重复值"><a href="#去重复值" class="headerlink" title="去重复值"></a>去重复值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--Distinct # 去除完全重复的值</div><div class="line">SELECT DISTINCT 机构 FROM allzjb ;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--Row_number() over(partation by col1 order by col2) 某个字段有重复值</div><div class="line">--【先根据某相同字段分组，根据其他字段排序，创建临时表；在提取排序=1的信息】</div><div class="line"></div><div class="line"># 对于相同的交易账号，取激活时间最前面的那一个账户的相关信息；</div><div class="line">Select *, Row_number() Over(partition by 交易账号 order by 激活时间) as 排序 Into #11 </div><div class="line">  From  exchange.ytx.ext_激活客户归属表;  </div><div class="line">Select * Into #2 From #11  where 排序 = &apos;1&apos;;</div></pre></td></tr></table></figure>
<h3 id="NULL"><a href="#NULL" class="headerlink" title="NULL"></a>NULL</h3><ul>
<li>what：空值NULL表示<strong>不存在的值，是一个未知值</strong>；并不表示0；</li>
<li>how ：包含<strong>空值的任何表达式结果均是一个未知值</strong><ul>
<li>Null + 1 = Null</li>
</ul>
</li>
</ul>
<blockquote>
<p>聚合函数中SUM( ) 与AVG( ) 会自动排除NULL进行计算；</p>
<p>Count( * ) 会计算空值；但Count( col )会排除空值</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 测试空值 - IS NULL</div><div class="line">SELECT * FROM allzjb   where 机构 is null ;</div><div class="line"></div><div class="line">-------------------------------------------------------</div><div class="line"># ISNULL 将NULL替换为某个值</div><div class="line">SELECT AVG(ISNULL(Weight, 50)) FROM Production.Product;  # 将Weight中的NULL替换为50</div></pre></td></tr></table></figure>
<ul>
<li><strong>isnull(col, 0 )：将col列中NULL值替换为0</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">## 处理空值 </div><div class="line"></div><div class="line"># Isnull() --将NULL替换为某个值</div><div class="line">Select Isnull(col, 0)  -- 对col列进行搜索，并将空值NULL转换为0；也可以是其他任意值/字符串</div><div class="line">--isnull(soucre_expression, prlacement_value)  # isnull是T-SQL特有的函数</div><div class="line"></div><div class="line">-----------------------------------------------------------------------------</div><div class="line"># Coalesce()</div><div class="line">Select Coalesce(Null, Null+1, 1+2, &quot;abc&quot;)  返回3</div><div class="line">--Coalesce(expression, expression,... ) # 接受一系列表达式或列，返回第一个非空值</div><div class="line"></div><div class="line">-----------------------------------------------------------------------------</div><div class="line"># Nullif()</div></pre></td></tr></table></figure>
<blockquote>
<p>NULL ：未定义的值 / 不存在<br>NA ：缺失数据<br>NaN ：无意义的数，比如sqrt(-2)， 0/0。<br>Inf ：正无穷大<br>-Inf ：负无穷大</p>
</blockquote>
<h3 id="表是否存在"><a href="#表是否存在" class="headerlink" title="表是否存在"></a>表是否存在</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># SQL SERVER中查询某个表或某个索引是否存在</div><div class="line"></div><div class="line">IF OBJECT_ID(N&apos;表名称&apos;, N&apos;U&apos;) IS NOT NULL </div><div class="line">DROP TABLE 表名称;</div><div class="line">--注意，普通表和临时表的使用差别：</div><div class="line">--若希望删除TEST库中的dbo.TestTable表，直接将dbo.TestTable作为表名即可。</div><div class="line">--若希望删除临时表dbo.#temp_table，需要以tempdb.dbo.#temp_table作为表名。</div><div class="line"></div><div class="line"></div><div class="line"># 查询表上的某个索引是否存在</div><div class="line">SELECT 1 FROM sys.indexes WHERE object_id=OBJECT_ID(@tname, N&apos;U&apos;) and NAME=@iname</div><div class="line">其中：@tname表示建索引的表名，@iname表示索引名。</div></pre></td></tr></table></figure>
<blockquote>
<p>在每一个数据库中都有sys.sysobjects用于包括在数据库中创建的每个对象（例如约束、默认值、日志、规则以及存储过程）。详细的说明信息参看MSDN上的帮助文档：sys.sysobjects</p>
<p><strong>OBJECT_ID</strong>的作用是<strong>返回架构范围内对象的数据库对象标识号</strong>。如果找不到数据库或对象的名称，例如相应名称不存在或拼写不正确，则会返回NULL。</p>
<p><strong>sys.indexes</strong>用于保存每<strong>个表格对象</strong>（例如，表、视图或表值函数）的<strong>索引或堆</strong>，详细的说明信息参看MSDN上的帮助文档：sys.indexes</p>
</blockquote>
<h2 id="数据运算与其他"><a href="#数据运算与其他" class="headerlink" title="数据运算与其他"></a>数据运算与其他</h2><h3 id="两行观测值相减"><a href="#两行观测值相减" class="headerlink" title="两行观测值相减"></a>两行观测值相减</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--根据某个字段先排序进行编号，创建为#a1；复制为另一个表#a2；通过联合，使得联合的条件为 #a1.rank+1 = #a2.rank</div><div class="line">Select *, order by 成交时间 as rank   --报错</div><div class="line">	into #a1 From [exchange].[YTX].[v_allcj] as cj;</div><div class="line">Select * into #a2 From #a1;</div><div class="line"></div><div class="line">Select a1.*, datediff(ss,#a1.成交时间,#a2.成交时间) s [交易间隔(s)] From #a1 </div><div class="line">  Left join #a2 On #a1.rank = #a2.rank +1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">----根据某个字段【分组】后排序编号；再通过唯一列联接，再设置条件 a.rank+1=b.rank 进行相减 【理论上应该是 a.rank=b.rank+1】</div><div class="line">--若a.rank=b.rank+1, 表示a表的rank=1 与b表的rank=2比较； </div><div class="line">--若a.rank+1=b.rank,表示a表的rank=1 变更为rank=2 与表b进行比较</div><div class="line"></div><div class="line"></div><div class="line">Select *, Row_number() over(partition by 交易账号 order by 成交时间) as [rank] into #a1</div><div class="line">  From [exchange].[YTX].[v_allcj] as cj;</div><div class="line">Select * into #a2 From #a1;</div><div class="line"></div><div class="line">Select #a1.*, datediff(ss,#a1.成交时间,#a2.成交时间) as [交易间隔(s)] From #a1 </div><div class="line">  Left join #a2 On #a1.交易账号 = #a2.交易账号</div><div class="line">  where #a1.rank+1 = #a2.rank</div><div class="line">  and datediff(ss,#a1.成交时间,#a2.成交时间) &lt; &apos;60&apos;</div></pre></td></tr></table></figure>
<h3 id="已知交易日计算差值"><a href="#已知交易日计算差值" class="headerlink" title="已知交易日计算差值"></a>已知交易日计算差值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 已知交易日，计算未交易的交易日间隔；</div><div class="line"></div><div class="line">Select Max(结算日期) As 最后交易日期 From</div><div class="line"></div><div class="line">Select Count(1) From       -----------计数</div><div class="line">	Inner Join b On 最后交易日 &lt; 结算日期</div></pre></td></tr></table></figure>
<h3 id="判断表单存在并删除"><a href="#判断表单存在并删除" class="headerlink" title="判断表单存在并删除"></a>判断表单存在并删除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">If Object_id(N&apos;tempdb.dbo.#b1&apos;,N&apos;U&apos;) Is Not Null Drop table #b1</div><div class="line">--若非临时表，无需加 数据库名</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="计算累加和"><a href="#计算累加和" class="headerlink" title="计算累加和"></a>计算累加和</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Select Sum([求和列]) Over(Partition by [分组列] Order by [排序列])</div><div class="line">	From ...</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="选取重复值"><a href="#选取重复值" class="headerlink" title="选取重复值"></a>选取重复值</h3><ul>
<li>通过<code>group by</code> 之后 <code>having count(*)&gt;1</code> 来进行筛选</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">--1.查某一列(或多列)的重复值(只可以查出重复记录的值</div><div class="line">---查找stuid，stuname重复的记录</div><div class="line">Select stuid，stuname </div><div class="line">  from stuinfo</div><div class="line">  group by stuid，stuname</div><div class="line">  having(count(*))&gt;1</div><div class="line"></div><div class="line">--2.查某一列有重复值的记录 (所有重复的记录，如果有两条记录重复的，就查出两条))</div><div class="line">--查找stuid重复的记录</div><div class="line">select * from stuinfo</div><div class="line">  where stuid in (select stuid from stuinfo group by stuid having(count(*))&gt;1 )</div><div class="line"></div><div class="line"></div><div class="line">/*--3.查某一列有重复值的记录(只显示多余的记录，也就是说如果有三条记录重复的，就显示两条)  —— 实际意义？？</div><div class="line">--查找stuid重复的记录; 前提：需有一个不重复的列，此示例为recno。</div><div class="line">select * from stuinfo s1</div><div class="line">  where recno not in (select max(recno) from stuinfo s2 where s1.stuid=s2.stuid)</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="取出一个字符串中最后一个特殊字符右边的字符-1"><a href="#取出一个字符串中最后一个特殊字符右边的字符-1" class="headerlink" title="取出一个字符串中最后一个特殊字符右边的字符"></a>取出一个字符串中最后一个特殊字符右边的字符</h3><ul>
<li>涉及 翻转 <code>reverse</code>  和 <code>charindex</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">DECLARE @aa VARCHAR(30)</div><div class="line">SET @aa = &apos;10*20*300&apos;</div><div class="line"></div><div class="line">-- 取最后一个*后的所有字符</div><div class="line">SELECT RIGHT(@aa, CHARINDEX(&apos;*&apos;,REVERSE(@aa)) - 1) </div><div class="line"></div><div class="line">-- 取定长字符串，如*后的3个字符</div><div class="line">SELECT SUBSTRING(@aa, LEN(@aa) - CHARINDEX(&apos;*&apos;,REVERSE(@aa)) + 2, 3)</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="问题-函数的长度参数无效"><a href="#问题-函数的长度参数无效" class="headerlink" title="问题 - 函数的长度参数无效"></a>问题 - 函数的长度参数无效</h3><ul>
<li>用逗号的位置得到的参数-1后是负数，不能做 LEFT和SUBSTRING的参数。</li>
</ul>
<ol>
<li><p>通过排序来进行查看，并且用Where进行限定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Select *, Convert(varchar(10), createTime, 120) As createTime2</div><div class="line">  , left(department, charindex(&apos;后&apos;, department,1)-1) As 老师</div><div class="line">  From [crm].[YTX].[t_wx_contact_monitor]</div><div class="line">  where tag = &apos;v11.JY.JY-QH-WECHAT-QY.0&apos; and error_code= 0</div><div class="line">    and charindex(&apos;后&apos;, department,1)-1 &gt;0</div></pre></td></tr></table></figure>
</li>
</ol>
<p><br></p>
<h3 id="问题-遇到-“遇到以零作除数错误”"><a href="#问题-遇到-“遇到以零作除数错误”" class="headerlink" title="问题 - 遇到 “遇到以零作除数错误”"></a>问题 - 遇到 “遇到以零作除数错误”</h3><ul>
<li>屏蔽了“遇到以零作除数错误” 的错误信息，这样的话，遇到0是除数的情况，就是赋值为Null</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SET ANSI_WARNINGS OFF;</div><div class="line">SET ARITHIGNORE ON;</div><div class="line">SET ARITHABORT OFF;</div><div class="line">GO</div><div class="line"></div><div class="line">SELECT 1 / 0</div><div class="line">SELECT Total/CountNr FROM dbo.TmpA1</div><div class="line"></div><div class="line">-----------</div><div class="line">NULL</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="系统查询相关"><a href="#系统查询相关" class="headerlink" title="系统查询相关"></a>系统查询相关</h2><h3 id="通过字段找表名"><a href="#通过字段找表名" class="headerlink" title="通过字段找表名"></a>通过字段找表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">------</span></div><div class="line"><span class="keyword">SELECT</span> sb.name </div><div class="line"><span class="keyword">FROM</span> syscolumns s <span class="keyword">JOIN</span> sysobjects sb <span class="keyword">ON</span> s.id=sb.id</div><div class="line"><span class="keyword">WHERE</span>  s.name=<span class="string">'你的字段名'</span></div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><ul>
<li><code>--</code> 双连字符；从开始到行尾均为注释；<strong>对于多行注释，必须在每一个开头多使用</strong></li>
<li><code>/*……*/</code>  正斜杠 星号；<ul>
<li>可在同一行，可另起一行；<strong>在这之间的全部内容均为注释（可跨行）；</strong></li>
<li>可在<strong>代码内执行</strong></li>
</ul>
</li>
</ul>
<p>参照文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">select * from #100</div><div class="line">pivot(</div><div class="line"></div><div class="line">sum(人数) for 资金等级 in ([100万以下])) as B  转置</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/软件应用/" rel="tag"># 软件应用</a>
          
            <a href="/tags/程序编程/" rel="tag"># 程序编程</a>
          
            <a href="/tags/SQL/" rel="tag"># SQL</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/05/软件应用_办公软件/Markdown/Markdown使用手册_Typora_高阶/" rel="next" title="Markdown使用_typora_高阶">
                <i class="fa fa-chevron-left"></i> Markdown使用_typora_高阶
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/08/软件应用_程序编程/SQL/SQL-Server/SQL-Server_系统结构/" rel="prev" title="SQL Server_系统结构">
                SQL Server_系统结构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
  <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODMzNi80OTA4"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Jimmy_Cai" />
          <p class="site-author-name" itemprop="name">Jimmy_Cai</p>
          <p class="site-description motion-element" itemprop="description">向死而生。做一个有品质的单身汪。</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">128</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/1998962ab991" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/jerry-cai-35/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/chf2012" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/facelife2012/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL-逻辑流"><span class="nav-number">1.</span> <span class="nav-text">SQL 逻辑流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Select-语法"><span class="nav-number">1.1.</span> <span class="nav-text">Select 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询语句的逻辑流"><span class="nav-number">1.2.</span> <span class="nav-text">查询语句的逻辑流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL编写标准"><span class="nav-number">1.3.</span> <span class="nav-text">SQL编写标准</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运算符介绍"><span class="nav-number">2.</span> <span class="nav-text">运算符介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级"><span class="nav-number">2.1.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通配符"><span class="nav-number">2.2.</span> <span class="nav-text">通配符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项与通用规则"><span class="nav-number">3.</span> <span class="nav-text">注意事项与通用规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方括号"><span class="nav-number">3.1.</span> <span class="nav-text">方括号 [ ]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#合并：字段-表格"><span class="nav-number">3.2.</span> <span class="nav-text">合并：字段+表格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Where条件"><span class="nav-number">3.3.</span> <span class="nav-text">Where条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Between-and"><span class="nav-number">3.4.</span> <span class="nav-text">Between and</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ALL、SOME、ANY"><span class="nav-number">3.5.</span> <span class="nav-text">ALL、SOME、ANY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#循环"><span class="nav-number">3.6.</span> <span class="nav-text">循环</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#while-break-continue的使用"><span class="nav-number">3.6.1.</span> <span class="nav-text">while,break,continue的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建与变更格式"><span class="nav-number">4.</span> <span class="nav-text">创建与变更格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#视图"><span class="nav-number">4.1.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变更格式"><span class="nav-number">4.2.</span> <span class="nav-text">变更格式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插入、更新、删除、合并数据"><span class="nav-number">5.</span> <span class="nav-text">插入、更新、删除、合并数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建数据"><span class="nav-number">5.1.</span> <span class="nav-text">创建数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入数据"><span class="nav-number">5.2.</span> <span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新数据"><span class="nav-number">5.3.</span> <span class="nav-text">更新数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除数据"><span class="nav-number">5.4.</span> <span class="nav-text">删除数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#判断是否存在后删除"><span class="nav-number">5.4.1.</span> <span class="nav-text">判断是否存在后删除</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#合并数据"><span class="nav-number">5.5.</span> <span class="nav-text">合并数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#返回修改后的数据"><span class="nav-number">5.6.</span> <span class="nav-text">返回修改后的数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-查询：字符串"><span class="nav-number">6.</span> <span class="nav-text">1. 查询：字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#行数-amp-字符数"><span class="nav-number">6.0.1.</span> <span class="nav-text">行数&字符数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#去空格"><span class="nav-number">6.0.2.</span> <span class="nav-text">去空格</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#取子串"><span class="nav-number">6.0.3.</span> <span class="nav-text">取子串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回特定位置"><span class="nav-number">6.0.4.</span> <span class="nav-text">返回特定位置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#取出一个字符串中最后一个特殊字符右边的字符"><span class="nav-number">6.0.4.1.</span> <span class="nav-text">取出一个字符串中最后一个特殊字符右边的字符</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#替换"><span class="nav-number">6.0.5.</span> <span class="nav-text">替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#合并"><span class="nav-number">6.0.6.</span> <span class="nav-text">合并</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式转换"><span class="nav-number">6.0.7.</span> <span class="nav-text">格式转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式转换-Convert"><span class="nav-number">6.0.8.</span> <span class="nav-text">格式转换 - Convert</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式转换-Cast"><span class="nav-number">6.0.9.</span> <span class="nav-text">格式转换  - Cast</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符串-正则表达式"><span class="nav-number">7.</span> <span class="nav-text">字符串 - 正则表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-查询：数字相关"><span class="nav-number">8.</span> <span class="nav-text">2. 查询：数字相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-查询：聚合函数"><span class="nav-number">9.</span> <span class="nav-text">3. 查询：聚合函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-查询：日期相关"><span class="nav-number">10.</span> <span class="nav-text">4. 查询：日期相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询：日期的应用"><span class="nav-number">10.1.</span> <span class="nav-text">查询：日期的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间戳"><span class="nav-number">10.2.</span> <span class="nav-text">时间戳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Datepart-设置周末为第一天"><span class="nav-number">10.3.</span> <span class="nav-text">Datepart 设置周末为第一天</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考：日期缩写参考"><span class="nav-number">10.4.</span> <span class="nav-text">参考：日期缩写参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-查询：表格相关"><span class="nav-number">11.</span> <span class="nav-text">5. 查询：表格相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#限定行数-TOP"><span class="nav-number">11.1.</span> <span class="nav-text">限定行数 - TOP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#With-Ties"><span class="nav-number">11.1.1.</span> <span class="nav-text">With Ties</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#随机行选择"><span class="nav-number">11.1.2.</span> <span class="nav-text">随机行选择</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分组-amp-排序"><span class="nav-number">11.2.</span> <span class="nav-text">分组&排序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分组"><span class="nav-number">11.2.1.</span> <span class="nav-text">分组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分组后筛选"><span class="nav-number">11.2.2.</span> <span class="nav-text">分组后筛选</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排序"><span class="nav-number">11.2.3.</span> <span class="nav-text">排序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数-Select-Over"><span class="nav-number">12.</span> <span class="nav-text">窗口函数 - Select Over()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#聚合子句"><span class="nav-number">12.1.</span> <span class="nav-text">聚合子句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排名-rank子句"><span class="nav-number">12.2.</span> <span class="nav-text">排名 - rank子句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分页"><span class="nav-number">12.3.</span> <span class="nav-text">分页</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#条件查询"><span class="nav-number">13.</span> <span class="nav-text">条件查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#联接与联合"><span class="nav-number">14.</span> <span class="nav-text">联接与联合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内联接"><span class="nav-number">14.1.</span> <span class="nav-text">内联接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#外联接"><span class="nav-number">14.2.</span> <span class="nav-text">外联接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#交叉联接"><span class="nav-number">14.3.</span> <span class="nav-text">交叉联接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#差集查询"><span class="nav-number">14.4.</span> <span class="nav-text">差集查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#联合-Union"><span class="nav-number">14.5.</span> <span class="nav-text">联合 - Union</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子查询"><span class="nav-number">15.</span> <span class="nav-text">子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#非相关子查询"><span class="nav-number">15.1.</span> <span class="nav-text">非相关子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#公用表表达式-CTE"><span class="nav-number">15.2.</span> <span class="nav-text">公用表表达式- CTE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关子查询"><span class="nav-number">15.3.</span> <span class="nav-text">相关子查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据透视-Pivot"><span class="nav-number">16.</span> <span class="nav-text">数据透视 - Pivot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#unpivot"><span class="nav-number">16.1.</span> <span class="nav-text">unpivot</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据清洗"><span class="nav-number">17.</span> <span class="nav-text">数据清洗</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#去重复值"><span class="nav-number">17.1.</span> <span class="nav-text">去重复值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NULL"><span class="nav-number">17.2.</span> <span class="nav-text">NULL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表是否存在"><span class="nav-number">17.3.</span> <span class="nav-text">表是否存在</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据运算与其他"><span class="nav-number">18.</span> <span class="nav-text">数据运算与其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#两行观测值相减"><span class="nav-number">18.1.</span> <span class="nav-text">两行观测值相减</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#已知交易日计算差值"><span class="nav-number">18.2.</span> <span class="nav-text">已知交易日计算差值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判断表单存在并删除"><span class="nav-number">18.3.</span> <span class="nav-text">判断表单存在并删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#计算累加和"><span class="nav-number">18.4.</span> <span class="nav-text">计算累加和</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选取重复值"><span class="nav-number">18.5.</span> <span class="nav-text">选取重复值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出一个字符串中最后一个特殊字符右边的字符-1"><span class="nav-number">18.6.</span> <span class="nav-text">取出一个字符串中最后一个特殊字符右边的字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题-函数的长度参数无效"><span class="nav-number">18.7.</span> <span class="nav-text">问题 - 函数的长度参数无效</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题-遇到-“遇到以零作除数错误”"><span class="nav-number">18.8.</span> <span class="nav-text">问题 - 遇到 “遇到以零作除数错误”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统查询相关"><span class="nav-number">19.</span> <span class="nav-text">系统查询相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过字段找表名"><span class="nav-number">19.1.</span> <span class="nav-text">通过字段找表名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注释"><span class="nav-number">20.</span> <span class="nav-text">注释</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jimmy_Cai</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("JjHJaD5nSfH7Snv1iJOyYCXJ-gzGzoHsz", "LoREb7wzyOhQIbmS4skuPfxv");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
